# 基础控制器类代码解释

## XZViewController (基础视图控制器)

### 文件位置
- XZVientiane/XZBase/BaseController/XZViewController.h/.m

### 类继承关系
- 继承自 UIViewController
- 作为项目中大部分控制器的基类

### 主要属性
- `navBar` (XZNavBar*): 自定义导航栏组件

### 核心方法说明

#### 生命周期方法
1. **dealloc**
   - 移除所有通知观察者
   - 打印控制器释放日志，用于内存泄漏监控

2. **viewDidLoad**
   - 设置背景色为统一的背景色 `[UIColor tyBgViewColor]`
   - 关闭自动调整滚动视图内边距
   - 创建自定义导航栏
   - 为导航栏标题添加点击手势
   - 设置左侧返回按钮样式（箭头图标）
   - 默认隐藏导航栏

3. **viewWillAppear/viewWillDisappear**
   - 集成友盟页面统计
   - 使用导航栏标题作为页面统计名称
   - 打印生命周期日志

4. **viewDidAppear/viewDidDisappear**
   - 仅打印生命周期日志，无其他操作

#### 导航栏相关方法
1. **createNavBar**
   - 隐藏系统导航栏
   - 创建自定义导航栏 XZNavBar
   - 设置左右按钮的点击事件

2. **leftNavButtonAction**
   - 默认实现：返回上一页

3. **rightNavButtonAction**
   - 仅打印日志，需子类重写实现具体功能

4. **titleLableTapped**
   - 标题点击事件，默认为空实现

### 内存管理
- **didReceiveMemoryWarning**: 打印内存警告日志

### 代码问题分析

#### 冗余代码
1. 注释掉的屏幕旋转相关代码（87-98行）可以删除
2. `viewDidAppear` 和 `viewDidDisappear` 仅打印日志，如无特殊需求可考虑移除

#### 潜在问题
1. **友盟统计页面名称问题**：使用 `navBar.titleLable.text` 作为统计名称，但在 `viewWillAppear` 时标题可能还未设置
2. **导航栏隐藏状态**：默认隐藏导航栏（44行），子类需要显式显示
3. **内存泄漏风险**：未看到明显泄漏，但需注意手势识别器的强引用

## XZWKWebViewBaseController (WebView基础控制器)

### 文件位置
- XZVientiane/XZBase/BaseController/XZWKWebViewBaseController.h/.m

### 类继承关系
- 继承自 XZViewController
- 作为所有WebView页面的基类

### 主要功能
1. 封装 WKWebView 的创建和管理
2. 提供 JavaScript 与原生的双向通信桥接
3. 处理 HTML 模板加载和渲染
4. 网络状态监控和错误处理
5. 性能优化（预加载、预创建等）

### 核心属性说明

#### WebView相关
- `webView`: WKWebView 实例
- `userContentController`: WebView 的用户内容控制器

#### 页面数据
- `pinUrl`: 页面URL
- `pinDataStr`: 页面数据字符串
- `pagetitle`: 页面标题
- `webViewDomain`: WebView域名
- `templateStr`: 模板字符串
- `nextPageData`: 下一页数据
- `replaceUrl`: 替换URL

#### 组件相关
- `templateDic`: 模板字典
- `componentJsAndCs`: 组件的JS和CSS
- `componentDic`: 组件字典
- 提供大写开头的兼容性属性（只读）

#### 状态管理
- `isCreat`: 是否已创建
- `isWebViewLoading`: WebView是否正在加载
- `isLoading`: 是否正在加载
- `pushType`: 推送类型（普通/模态/警告）

#### 性能优化
- `webViewLoadingQueue`: WebView加载操作队列
- `htmlProcessingQueue`: HTML处理队列
- `isWebViewPreCreated`: WebView是否已预创建
- `isBridgeReady`: JavaScript桥接是否就绪
- `isLoadingInProgress`: 防止重复加载

### 核心方法说明

#### WebView管理
1. **addWebView**: 添加WebView到视图
2. **loadWebBridge**: 加载JavaScript桥接
3. **domainOperate**: 域名操作处理
4. **loadHTMLContent**: 加载HTML内容
5. **retryHTMLLoading**: 重试HTML加载

#### 性能优化方法
1. **preloadHTMLTemplates**: 预加载HTML模板（类方法）
2. **preCreateWebViewIfNeeded**: 预创建WebView
3. **optimizedLoadHTMLContent**: 优化的HTML加载
4. **setupOptimizedJavaScriptBridge**: 优化的JS桥接设置
5. **isReadyForJavaScriptExecution**: 检查JS执行状态
6. **fallbackToOriginalLoadMethod**: 回退到原始加载方法

#### JavaScript交互
1. **jsCallObjc:completion:**: JS调用原生（带回调）
2. **jsCallObjc:jsCallBack:**: JS调用原生（带JS回调）
3. **objcCallJs:**: 原生调用JS
4. **handleJavaScriptCall:completion:**: 处理JS调用
5. **callJavaScript:completion:**: 执行JS代码
6. **safelyEvaluateJavaScript:completion:**: 安全执行JS

#### 网络监控
1. **listenToTimer**: 启动网络监控定时器
2. **networkNoteBtClick**: 网络提示按钮点击

#### 页面状态
1. **isShowingOnKeyWindow**: 是否显示在主窗口
2. **isHaveNativeHeader:**: 是否有原生导航栏

### 设计模式和架构特点

1. **桥接模式**: 使用 WKWebViewJavascriptBridge 实现JS与原生的通信
2. **队列管理**: 使用 NSOperationQueue 管理加载任务
3. **延迟加载**: 支持WebView的预创建和延迟加载
4. **状态管理**: 多个状态标志位管理复杂的加载流程

### 潜在问题

1. **状态管理复杂**: 过多的状态标志位可能导致状态管理混乱
2. **兼容性属性**: 大写开头的属性名不符合Objective-C命名规范
3. **内存管理**: WebView和定时器需要注意及时释放
4. **错误处理**: 需要加强错误处理和用户反馈机制