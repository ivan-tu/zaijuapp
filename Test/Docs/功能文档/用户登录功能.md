# ç”¨æˆ·ç™»å½•åŠŸèƒ½æ–‡æ¡£

## åŠŸèƒ½æ¦‚è¿°
åœ¨å±€APPæ”¯æŒå¤šç§ç™»å½•æ–¹å¼ï¼ŒåŒ…æ‹¬å¾®ä¿¡ç™»å½•ã€Apple IDç™»å½•ã€æ‰‹æœºå·ç™»å½•ç­‰ã€‚ç™»å½•åŠŸèƒ½é€šè¿‡JavaScriptä¸Nativeçš„æ¡¥æ¥å®ç°ï¼Œç¡®ä¿ç”¨æˆ·èº«ä»½çš„å®‰å…¨éªŒè¯ã€‚

## æ¶‰åŠæ–‡ä»¶
- `CFJClientH5Controller.m` - ä¸»è¦ç™»å½•é€»è¾‘å®ç°
- `XZWKWebViewBaseController.m` - WebViewåŸºç¡€äº¤äº’
- `AppDelegate.m` - å¾®ä¿¡SDKåˆå§‹åŒ–
- `shareInfo.json` - ç¬¬ä¸‰æ–¹SDKé…ç½®
- `manifest/static/app/webviewbridge.js` - JSç«¯ç™»å½•æ¥å£

## ç™»å½•æ–¹å¼

### 1. å¾®ä¿¡ç™»å½•

#### å®ç°æµç¨‹
1. **JSç«¯å‘èµ·ç™»å½•è¯·æ±‚**
   ```javascript
   webViewCall('loginWeixin', {
       success: function(res) {
           // å¤„ç†ç™»å½•æˆåŠŸ
       },
       fail: function(err) {
           // å¤„ç†ç™»å½•å¤±è´¥
       }
   });
   ```

2. **Nativeç«¯å¤„ç†** (CFJClientH5Controller.m:2196-2233)
   ```objc
   else if ([function isEqualToString:@"loginWeixin"]) {
       // è®°å½•æ—¥å¿—
       NSLog(@"åœ¨å±€ğŸ“¥ [å¾®ä¿¡ç™»å½•] æ¥æ”¶åˆ°JavaScriptè¯·æ±‚");
       
       // æ£€æŸ¥å¾®ä¿¡æ˜¯å¦å®‰è£…
       if ([WXApi isWXAppInstalled]) {
           // æ„å»ºå¾®ä¿¡ç™»å½•è¯·æ±‚
           SendAuthReq *req = [[SendAuthReq alloc] init];
           req.scope = @"snsapi_userinfo";
           req.state = @"hi3zaiju";
           
           // ä¿å­˜å›è°ƒå‡½æ•°
           self.jsWeiXinLoginCallback = jsCallBack;
           
           // å‘é€è¯·æ±‚åˆ°å¾®ä¿¡
           [WXApi sendReq:req completion:nil];
       } else {
           // å¾®ä¿¡æœªå®‰è£…ï¼Œè¿”å›é”™è¯¯
           [self showToast:@"è¯·å…ˆå®‰è£…å¾®ä¿¡"];
           jsCallBack(@{@"msg": @"è¯·å…ˆå®‰è£…å¾®ä¿¡", @"code": @(-1)});
       }
   }
   ```

3. **å¾®ä¿¡å›è°ƒå¤„ç†** (AppDelegate.m)
   ```objc
   - (BOOL)application:(UIApplication *)app openURL:(NSURL *)url options:(NSDictionary<UIApplicationOpenURLOptionsKey,id> *)options {
       if ([url.scheme isEqualToString:WEIXINAPPID]) {
           return [WXApi handleOpenURL:url delegate:[WXApiManager sharedManager]];
       }
   }
   ```

4. **ç™»å½•ç»“æœå¤„ç†** (é€šè¿‡é€šçŸ¥)
   ```objc
   [[NSNotificationCenter defaultCenter] addObserverForName:@"weixinLogin" 
       object:nil 
       queue:[NSOperationQueue mainQueue] 
       usingBlock:^(NSNotification * _Nonnull note) {
           // å¤„ç†å¾®ä¿¡ç™»å½•ç»“æœ
           NSDictionary *userInfo = note.userInfo;
           if (self.jsWeiXinLoginCallback) {
               self.jsWeiXinLoginCallback(userInfo);
           }
   }];
   ```

### 2. Apple IDç™»å½•

#### å®ç°æµç¨‹
1. **JSç«¯è¯·æ±‚**
   ```javascript
   webViewCall('loginApple', {
       success: function(res) {
           // resåŒ…å«: userID, email, fullNameç­‰
       }
   });
   ```

2. **Nativeç«¯å®ç°** (CFJClientH5Controller.m:2246-2285)
   ```objc
   else if ([function isEqualToString:@"loginApple"]) {
       if (@available(iOS 13.0, *)) {
           // åˆ›å»ºAppleç™»å½•è¯·æ±‚
           ASAuthorizationAppleIDProvider *provider = [[ASAuthorizationAppleIDProvider alloc] init];
           ASAuthorizationAppleIDRequest *request = [provider createRequest];
           request.requestedScopes = @[ASAuthorizationScopeFullName, ASAuthorizationScopeEmail];
           
           // åˆ›å»ºæˆæƒæ§åˆ¶å™¨
           ASAuthorizationController *controller = [[ASAuthorizationController alloc] 
               initWithAuthorizationRequests:@[request]];
           controller.delegate = self;
           controller.presentationContextProvider = self;
           
           // ä¿å­˜å›è°ƒ
           self.jsAppleLoginCallback = jsCallBack;
           
           // æ‰§è¡Œç™»å½•
           [controller performRequests];
       } else {
           jsCallBack(@{@"msg": @"ç³»ç»Ÿç‰ˆæœ¬ä¸æ”¯æŒ", @"code": @(-1)});
       }
   }
   ```

3. **æˆæƒå›è°ƒå¤„ç†**
   ```objc
   - (void)authorizationController:(ASAuthorizationController *)controller 
       didCompleteWithAuthorization:(ASAuthorization *)authorization {
       if ([authorization.credential isKindOfClass:[ASAuthorizationAppleIDCredential class]]) {
           ASAuthorizationAppleIDCredential *credential = authorization.credential;
           
           // æå–ç”¨æˆ·ä¿¡æ¯
           NSString *userID = credential.user;
           NSString *email = credential.email ?: @"";
           NSPersonNameComponents *fullName = credential.fullName;
           
           // è¿”å›ç»™JS
           if (self.jsAppleLoginCallback) {
               self.jsAppleLoginCallback(@{
                   @"userID": userID,
                   @"email": email,
                   @"fullName": [self formatFullName:fullName],
                   @"code": @(0)
               });
           }
       }
   }
   ```

### 3. æ‰‹æœºå·ç™»å½•

#### å®ç°æµç¨‹
1. **è·å–éªŒè¯ç **
   ```javascript
   webViewCall('sendSMSCode', {
       phone: '13800138000',
       type: 'login'
   });
   ```

2. **éªŒè¯ç™»å½•**
   ```javascript
   webViewCall('request', {
       url: '/api/user/login',
       method: 'POST',
       data: {
           phone: '13800138000',
           code: '123456'
       }
   });
   ```

## ç™»å½•çŠ¶æ€ç®¡ç†

### 1. çŠ¶æ€å­˜å‚¨
- **iOSç«¯**: ä½¿ç”¨NSUserDefaultså­˜å‚¨
  ```objc
  [[NSUserDefaults standardUserDefaults] setBool:YES forKey:@"isLogin"];
  [[NSUserDefaults standardUserDefaults] setObject:userInfo forKey:@"userInfo"];
  ```

- **JSç«¯**: é€šè¿‡localStorageæˆ–sessionStorageå­˜å‚¨
  ```javascript
  localStorage.setItem('isLogin', 'true');
  localStorage.setItem('userInfo', JSON.stringify(userInfo));
  ```

### 2. çŠ¶æ€åŒæ­¥
é€šè¿‡`detectAndHandleLoginStateChange`æ–¹æ³•æ£€æµ‹å¹¶åŒæ­¥ç™»å½•çŠ¶æ€ï¼š
```objc
- (void)detectAndHandleLoginStateChange {
    BOOL iosLoginState = [[NSUserDefaults standardUserDefaults] boolForKey:@"isLogin"];
    
    // è·å–JSç«¯çŠ¶æ€
    [self.webView evaluateJavaScript:@"localStorage.getItem('isLogin')" 
        completionHandler:^(id result, NSError *error) {
            BOOL jsLoginState = [result isEqualToString:@"true"];
            
            // çŠ¶æ€ä¸ä¸€è‡´æ—¶åŒæ­¥
            if (iosLoginState != jsLoginState) {
                [self syncLoginState:iosLoginState];
            }
    }];
}
```

### 3. ç™»å‡ºå¤„ç†
```objc
else if ([function isEqualToString:@"logout"]) {
    // æ¸…é™¤iOSç«¯çŠ¶æ€
    [[NSUserDefaults standardUserDefaults] setBool:NO forKey:@"isLogin"];
    [[NSUserDefaults standardUserDefaults] removeObjectForKey:@"userInfo"];
    [[NSUserDefaults standardUserDefaults] removeObjectForKey:@"token"];
    
    // é€šçŸ¥JSç«¯
    [self objcCallJs:[[HybridManager shareInstance] objcCallJsWithFn:@"onLogout" data:nil]];
    
    jsCallBack(@{@"code": @(0), @"msg": @"ç™»å‡ºæˆåŠŸ"});
}
```

## å®‰å…¨æªæ–½

### 1. Tokenç®¡ç†
- Tokenå­˜å‚¨åœ¨Keychainä¸­ï¼Œä½¿ç”¨SAMKeychainåº“
- æ¯æ¬¡è¯·æ±‚è‡ªåŠ¨æºå¸¦Token
- Tokenè¿‡æœŸè‡ªåŠ¨åˆ·æ–°

### 2. æ•æ„Ÿä¿¡æ¯ä¿æŠ¤
- ä¸åœ¨æ—¥å¿—ä¸­è¾“å‡ºç”¨æˆ·æ•æ„Ÿä¿¡æ¯
- ä½¿ç”¨HTTPSä¼ è¾“æ‰€æœ‰ç™»å½•è¯·æ±‚
- å¯†ç ç­‰æ•æ„Ÿå­—æ®µåœ¨ä¼ è¾“å‰åŠ å¯†

### 3. é˜²é‡å¤ç™»å½•
- ç™»å½•è¿‡ç¨‹ä¸­ç¦ç”¨ç™»å½•æŒ‰é’®
- ä½¿ç”¨loadingçŠ¶æ€é˜²æ­¢é‡å¤ç‚¹å‡»
- ç™»å½•è¯·æ±‚æ·»åŠ é˜²æŠ–å¤„ç†

## é”™è¯¯å¤„ç†

### 1. å¸¸è§é”™è¯¯ç 
- `-1`: é€šç”¨é”™è¯¯ï¼ˆå¦‚å¾®ä¿¡æœªå®‰è£…ï¼‰
- `-2`: ç”¨æˆ·å–æ¶ˆæ“ä½œ
- `-3`: ç½‘ç»œé”™è¯¯
- `401`: Tokenè¿‡æœŸ
- `403`: æ— æƒé™

### 2. é”™è¯¯æç¤º
```objc
// ç»Ÿä¸€é”™è¯¯æç¤ºæ–¹æ³•
- (void)handleLoginError:(NSString *)errorMessage callback:(WVJBResponseCallback)callback {
    [self showToast:errorMessage];
    if (callback) {
        callback(@{
            @"code": @(-1),
            @"msg": errorMessage
        });
    }
}
```

## æ€§èƒ½ä¼˜åŒ–

### 1. ç™»å½•ç¼“å­˜
- ç¼“å­˜ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼Œå‡å°‘é‡å¤è¯·æ±‚
- è‡ªåŠ¨ç™»å½•åŠŸèƒ½ï¼Œè®°ä½ç™»å½•çŠ¶æ€

### 2. é¢„åŠ è½½
- é¢„åŠ è½½ç™»å½•ç›¸å…³çš„WebViewé¡µé¢
- æå‰åˆå§‹åŒ–ç¬¬ä¸‰æ–¹SDK

## å·²çŸ¥é—®é¢˜

### 1. å¾®ä¿¡ç™»å½•
- éƒ¨åˆ†è®¾å¤‡ä¸Šå¾®ä¿¡æˆæƒåè¿”å›APPå¤±è´¥
- å¾®ä¿¡æœªå®‰è£…æ—¶çš„æç¤ºä¸å¤Ÿå‹å¥½

### 2. Appleç™»å½•
- iOS 13ä»¥ä¸‹ç‰ˆæœ¬ä¸æ”¯æŒ
- ç”¨æˆ·å–æ¶ˆæˆæƒåçš„å¤„ç†ä¸å®Œå–„

### 3. çŠ¶æ€åŒæ­¥
- iOSç«¯å’ŒJSç«¯ç™»å½•çŠ¶æ€å¯èƒ½ä¸ä¸€è‡´
- å¤šWebViewå®ä¾‹é—´çš„çŠ¶æ€åŒæ­¥é—®é¢˜

## ä¼˜åŒ–å»ºè®®

1. **ç»Ÿä¸€ç™»å½•ç®¡ç†å™¨**
   - åˆ›å»ºä¸“é—¨çš„LoginManagerç±»
   - ç»Ÿä¸€å¤„ç†å„ç§ç™»å½•æ–¹å¼
   - é›†ä¸­ç®¡ç†ç™»å½•çŠ¶æ€

2. **æ”¹è¿›é”™è¯¯å¤„ç†**
   - æ›´è¯¦ç»†çš„é”™è¯¯åˆ†ç±»
   - ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
   - é”™è¯¯ä¸ŠæŠ¥æœºåˆ¶

3. **å¢å¼ºå®‰å…¨æ€§**
   - å®ç°è®¾å¤‡ç»‘å®š
   - æ·»åŠ ç™»å½•å¼‚å¸¸æ£€æµ‹
   - æ”¯æŒç”Ÿç‰©è¯†åˆ«ç™»å½•

4. **ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ**
   - æ·»åŠ ä¸€é”®ç™»å½•åŠŸèƒ½
   - ä¼˜åŒ–ç™»å½•æµç¨‹
   - æ”¯æŒæ¸¸å®¢æ¨¡å¼