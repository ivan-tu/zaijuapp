# 照片分页加载优化方案

## 当前问题
虽然通过限制加载数量（5000张）解决了卡死问题，但仍存在以下不足：
1. 用户无法查看超过5000张的照片
2. 一次性加载5000张仍然需要较长时间
3. 内存占用较大

## 建议的分页加载方案

### 1. 实现思路
```objc
// 每页加载数量
static const NSUInteger kPhotosPerPage = 100;

// 在TZPhotoPickerController中添加分页属性
@property (nonatomic, assign) NSUInteger currentPage;
@property (nonatomic, assign) NSUInteger totalPages;
@property (nonatomic, strong) NSMutableArray *allAssets; // 保存所有PHAsset
@property (nonatomic, assign) BOOL isLoadingMore;
```

### 2. 初始加载
只加载第一页（100张）照片：
```objc
- (void)loadFirstPage {
    NSUInteger endIndex = MIN(kPhotosPerPage, self.allAssets.count);
    NSArray *firstPageAssets = [self.allAssets subarrayWithRange:NSMakeRange(0, endIndex)];
    
    // 转换为TZAssetModel
    [self convertAssetsToModels:firstPageAssets completion:^(NSArray *models) {
        self.models = [NSMutableArray arrayWithArray:models];
        [self.collectionView reloadData];
    }];
}
```

### 3. 滚动加载更多
监听滚动事件，接近底部时加载下一页：
```objc
- (void)scrollViewDidScroll:(UIScrollView *)scrollView {
    if (self.isLoadingMore) return;
    
    CGFloat offsetY = scrollView.contentOffset.y;
    CGFloat contentHeight = scrollView.contentSize.height;
    CGFloat frameHeight = scrollView.frame.size.height;
    
    // 距离底部还有200像素时开始加载
    if (offsetY + frameHeight > contentHeight - 200) {
        [self loadMorePhotos];
    }
}

- (void)loadMorePhotos {
    if (self.currentPage >= self.totalPages) return;
    
    self.isLoadingMore = YES;
    self.currentPage++;
    
    NSUInteger startIndex = self.currentPage * kPhotosPerPage;
    NSUInteger endIndex = MIN(startIndex + kPhotosPerPage, self.allAssets.count);
    NSArray *pageAssets = [self.allAssets subarrayWithRange:NSMakeRange(startIndex, endIndex - startIndex)];
    
    [self convertAssetsToModels:pageAssets completion:^(NSArray *models) {
        [self.models addObjectsFromArray:models];
        [self.collectionView reloadData];
        self.isLoadingMore = NO;
    }];
}
```

### 4. 优化用户体验

#### 显示加载提示
```objc
// 在底部显示加载指示器
- (UICollectionReusableView *)collectionView:(UICollectionView *)collectionView 
           viewForSupplementaryElementOfKind:(NSString *)kind 
                                 atIndexPath:(NSIndexPath *)indexPath {
    if ([kind isEqualToString:UICollectionElementKindSectionFooter]) {
        LoadingFooterView *footer = [collectionView dequeueReusableSupplementaryViewOfKind:kind 
                                                                       withReuseIdentifier:@"LoadingFooter" 
                                                                              forIndexPath:indexPath];
        footer.hidden = (self.currentPage >= self.totalPages);
        return footer;
    }
    return nil;
}
```

#### 快速跳转
提供快速跳转到顶部/底部的功能：
```objc
// 跳转到最新照片
- (void)scrollToLatestPhotos {
    if (self.currentPage < self.totalPages - 1) {
        // 先加载最后一页
        [self loadLastPage];
    }
    
    NSIndexPath *lastIndexPath = [NSIndexPath indexPathForItem:self.models.count - 1 inSection:0];
    [self.collectionView scrollToItemAtIndexPath:lastIndexPath 
                                 atScrollPosition:UICollectionViewScrollPositionBottom 
                                         animated:YES];
}
```

### 5. 内存优化

#### 释放不可见的图片缓存
```objc
- (void)collectionView:(UICollectionView *)collectionView 
       didEndDisplayingCell:(UICollectionViewCell *)cell 
    forItemAtIndexPath:(NSIndexPath *)indexPath {
    TZAssetCell *assetCell = (TZAssetCell *)cell;
    [assetCell.imageView.image = nil]; // 释放图片
}
```

#### 使用缩略图
对于列表显示，使用小尺寸的缩略图：
```objc
CGSize thumbnailSize = CGSizeMake(200, 200); // 使用更小的缩略图
[[PHImageManager defaultManager] requestImageForAsset:asset 
                                           targetSize:thumbnailSize 
                                          contentMode:PHImageContentModeAspectFill 
                                              options:nil 
                                        resultHandler:^(UIImage *result, NSDictionary *info) {
    // 显示缩略图
}];
```

## 实施建议

### 第一阶段：基础分页
1. 实现基本的分页加载逻辑
2. 每页100-200张照片
3. 滚动到底部自动加载

### 第二阶段：性能优化
1. 添加图片缓存管理
2. 实现预加载机制
3. 优化内存使用

### 第三阶段：用户体验
1. 添加加载进度提示
2. 支持快速跳转
3. 添加下拉刷新

## 预期效果
1. 初始加载时间从5-10秒降低到1秒以内
2. 内存占用减少80%
3. 支持查看所有照片（不限制5000张）
4. 流畅的滚动体验