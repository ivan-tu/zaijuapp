# 升级 Todos

本文记录升级时的任务列表

## 原项目分析

- **已完成**1.分析已知的项目问题避免新项目被污染
- **已完成**2.生成原项目简介和目录说明
- **已完成**3.生成原项目功能说明
- **已完成**4.生成原项目依赖说明
- **已完成**5.生成原项目编写习惯和规范

## 制定升级计划

- **已完成**1.阅读原项目分析，制定升级计划
- **已完成**2.制定最终升级文档
- **已完成**3.生成按步骤的 Claude 指令

## 执行升级计划

1. 创建 swift 项目，并复制原项目文件、升级文档到新项目（用户完成）

2. AI 执行升级任务

2.0 创建升级专用CLAUDE.md文档

指令：基于以下资源创建Swift升级专用的CLAUDE.md文档。
1）阅读 /Users/ivan/工作/Tuweia/app/在局/zaijuapp/CLAUDE.md 了解原项目规范；
2）参考 Test/Docs/升级到Swift/CLAUDE.md模板.md；
3）结合升级文档中的所有要求，创建完整的CLAUDE.md；
4）确保包含：Swift编码规范和最佳实践、MVVM-C架构实现指南、JSBridge迁移详细步骤、每个任务的具体执行代码示例、测试模板和验证清单；
5）将文件保存为项目根目录的 CLAUDE_SWIFT.md。

2.0.1 第三方库兼容性检查

指令：检查所有第三方库的Swift兼容性并制定迁移方案。
1）创建依赖映射表：将AFNetworking映射到Alamofire、Masonry映射到SnapKit、JSONModel映射到Codable等；
2）检查SDK版本：微信SDK使用2.0.2+、支付宝SDK使用15.8.0+、高德地图使用AMapFoundation 1.8.0+；
3）更新Podfile配置：添加platform :ios, '15.0'和use_frameworks!；
4）记录需要Bridging的OC库清单；
5）创建ThirdParty/Dependencies.md文档记录所有依赖及版本。

2.0.2 资源文件迁移

指令：从原项目迁移所有资源文件到Swift项目。
1）App图标迁移：
   - 从原项目复制 AppIcon.appiconset 到 Resources/Assets.xcassets/
   - 确保包含所有尺寸：20pt、29pt、40pt、60pt（@2x和@3x）
   - 验证 Info.plist 中的 CFBundleIcons 配置正确
2）启动页资源：
   - 复制 LaunchScreen.storyboard 或 LaunchImage
   - 迁移启动图片资源到 Assets.xcassets
   - 配置 Info.plist 的 UILaunchStoryboardName
3）TabBar图标：
   - 迁移所有TabBar图标（正常态和选中态）
   - 确保图标命名规范：tabbar_home、tabbar_home_selected等
   - 使用 @2x 和 @3x 版本
4）通用图片资源：
   - 迁移 Images.xcassets 中的所有图片
   - 保持原有的命名和文件夹结构
   - 检查图片引用确保代码中能正确访问
5）其他资源：
   - 迁移自定义字体文件到 Resources/Fonts/
   - 迁移音频文件到 Resources/Audio/
   - 迁移 Localizable.strings 等本地化文件
   - 更新 Info.plist 中的字体配置
6）manifest资源包：
   - 完整复制 manifest/ 目录到项目根目录
   - 确保 Build Phases 中正确配置资源复制

2.1 项目基础配置

指令：配置 Swift 项目基础环境，执行以下具体操作。
1）在 Info.plist 中添加完整权限配置：
   - NSCameraUsageDescription = "在局需要访问您的相机以拍摄照片"
   - NSPhotoLibraryUsageDescription = "在局需要访问您的相册以选择图片"
   - NSLocationWhenInUseUsageDescription = "在局需要获取您的位置信息以提供本地服务"
   - NSLocationAlwaysUsageDescription = "在局需要持续获取您的位置信息"
   - NSMicrophoneUsageDescription = "在局需要访问您的麦克风以录制音频"
   - NSAppTransportSecurity > NSAllowsArbitraryLoads = YES
2）配置 URL Schemes 在 CFBundleURLTypes 数组中添加：wx10a321f7fbdd6023 和 zaiju；
3）使用命令创建项目目录：mkdir -p ZaiJu/{App,Core/{Architecture,Networking,Storage,JSBridge},Features/{Home,User,Payment},Services,Resources,Extensions,ThirdParty}；
4）配置.gitignore 添加 Swift 特定忽略项：*.xcuserstate、DerivedData/、.swiftpm/、.build/；
5）创建 ZaiJu-Bridging-Header.h 并在 Build Settings 中设置 SWIFT_OBJC_BRIDGING_HEADER = $(PROJECT_DIR)/ZaiJu/ZaiJu-Bridging-Header.h。

2.2 架构基础搭建

指令：实现 MVVM-C 架构基础组件。
1）在 Core/Architecture/创建 Coordinator.swift 定义 Coordinator 协议；
2）实现 BaseCoordinator 和 AppCoordinator；
3）创建 BaseViewModel 和 BaseViewController 基类；
4）集成 Swinject 并创建 DependencyContainer；
5）实现 NavigationRouter 处理模块间导航。确保所有基础类都支持依赖注入。

2.3 网络层实现

指令：基于原项目 CFJNetworkHelper 实现 Swift 网络层。
1）创建 Services/Network/NetworkManager.swift，使用 URLSession 和 async/await；
2）定义 APIEndpoint 枚举管理所有接口；
3）实现 Request 和 Respons e 的 Codable 模型；
4）创建 NetworkError 统一错误处理；
5）实现请求拦截器处理 token 和公共参数；
6）添加网络状态监测功能。

2.4 数据存储层实现

指令：实现数据存储功能和数据迁移。
1）创建 Services/Storage/StorageManager.swift 管理本地存储；
2）实现 UserDefaults 的类型安全封装，使用 @propertyWrapper 实现；
3）创建 KeychainManager 处理敏感数据，保持与原项目相同的 service 和 account；
4）迁移原项目的 XZUserInformation 到 Swift User 模型，确保字段映射正确；
5）实现 DataMigrationManager 执行数据迁移：
   - 检测是否需要迁移（通过版本标记）
   - 迁移 UserDefaults（保持相同的 key）
   - 迁移 Keychain 数据（用户 token、登录信息）
   - 迁移 Cookie（从原 WKWebView 获取并设置）
   - 迁移完成后设置迁移标记避免重复迁移。

2.5 WebView 核心功能

指令：迁移 WebView 核心功能。
1）创建 Core/WebView/BaseWebViewController.swift 替代 XZWKWebViewBaseController；
2）实现 WKWebView 配置、进度条、导航控制；
3）处理 Cookie 同步和 UserAgent 设置；
4） 迁移 handleNavigationAction 等核心方法；
5）实现 iOS18 的 viewDidAppear 修复；
6）添加 WebView 性能监控。

2.6 JSBridge 架构实现

指令：构建类型安全的 JSBridge 系统。
1）创建 Core/JSBridge/JSBridgeManager.swift；
2）定义 JSMessage 协议和 JSResponse 结构；
3）实现 JSHandler 基类和 JSHandlerProtocol；
4）创建 JSBridgeConfigurati on 管理 Handler 注册；
5）使用 async/await 重构所有 JS 调用；
6）实现 JS 调用的日志和调试系统。

2.7 JSHandler 模块实现 - 第一批

指令：实现高优先级 JSHandler。
1）创建 Features/JSHandlers/目录；
2）实现 JSNavigationHandler（包含 push、pop、setNavigationBar 等 15 个方法）；
3）实现 JSUIHandler（toast、loading、alert、actio nSheet 等 10 个方法）；
4）实现 JSUserHandler（login、logout、getUserInfo 等方法）；
5）为每个 Handler 编写单元测试。参考原 jsCallObjc 中对应实现。

2.8 支付功能实现

指令：实现支付相关功能。
1）创建 Features/Payment/目录；
2）实现 JSPaymentHandler 处理支付请求；
3）创建 WeChatPaymentService 集成微信支付 SDK；
4）创建 AlipayPaymentService 集成支付宝 SDK；
5）实 现 PaymentCoordinator 统一支付流程；
6）添加支付结果回调处理。确保与原项目支付流程完全一致。

2.9 定位和地区选择

指令：迁移定位相关功能。
1）实现 JSLocationHandler 的所有定位方法；
2）将 MOFSPickerManager 完整迁移到 Swift，保持 UI 和交互一致；
3）创建 LocationService 封装 CoreLocation；
4）实现地区数据的加载 和缓存；
5）处理定位权限请求；
6）确保 selectLocation 功能正常工作。

2.10 JSHandler 模块实现 - 第二批

指令：实现剩余 JSHandler。
1）实现 JSShareHandler（微信分享、朋友圈分享等）；
2）实现 JSMediaHandler（相册、拍照、视频选择）；
3）实现 JSFileHandler（文件下载、预览）；
4）实现 JSNetworkHandle r（原生网络请求代理）；
5）实现 JSPageLifecycleHandler（页面生命周期）；
6）实现 JSDeviceHandler 和 JSMiscHandler。

2.11 UI 组件迁移

指令：迁移自定义 UI 组件。
1）使用 SnapKit 创建 Extensions/UIView+Layout.swift；
2）迁移自定义导航栏 XZNavigationController；
3）迁移 TabBarController 相关功能；
4）实现 Loading、HUD 等 UI 组件；
5） 迁移所有自定义 View；
6）确保支持暗黑模式。所有 UI 保持与原项目视觉一致。

2.12 第三方 SDK 集成

指令：集成所有第三方 SDK。
1）使用 SPM 添加：Alamofire、SnapKit、Kingfisher；
2）通过 CocoaPods 添加：微信 SDK、支付宝 SDK、友盟 SDK、高德地图 SDK；
3）配置 Bridging-Header 导入 OC 版 SDK；
4）创建 Thir dParty/目录封装 SDK 调用；
5）实现 WeChatManager、UMengManager 等服务类；
6）处理 SDK 初始化和配置。

2.13 工具类和扩展

指令：迁移工具类到 Swift。
1）创建 Extensions/目录；
2）实现 String、UIColor、UIImage 等常用扩展；
3）迁移日期处理、加密解密等工具方法；
4）创建错误码管理系统 ErrorCode.swift；
5）实现设备信息 获取 DeviceInfo.swift；
6）迁移所有 NSString 分类方法到 String 扩展。

2.14 推送和统计功能

指令：实现推送和统计。
1）实现推送通知处理（注册、接收、点击）；
2）集成友盟推送功能；
3）实现统计事件追踪；
4）创建 AnalyticsService 统一管理；
5）处理推送权限请求；
6）实现推送消息的路由跳 转。

2.15 性能优化和代码清理

指令：优化代码质量。
1）配置 SwiftLint 并修复所有警告；
2）移除所有 print 语句，使用正规日志系统；
3）检查并修复所有强制解包；
4）优化启动流程确保 2 秒内启动；
5）实现图片懒加载；
6）添加内存缓存 管理；
7）确保没有循环引用。

2.16 测试覆盖

指令：实施分层测试策略。
1）单元测试（目标 80% 覆盖率）：
   - 为每个 ViewModel 编写测试，包括状态变化和业务逻辑
   - 为每个 Service 编写测试，使用 Mock 对象
   - 为工具类和扩展编写测试，确保边界情况处理
2）集成测试：
   - 测试每个 JSHandler 的所有方法
   - 测试网络层的真实请求（使用测试环境）
   - 测试数据存储的 CRUD 操作
3）UI 测试（关键流程）：
   - 用户登录流程（包括微信登录）
   - 支付流程（微信/支付宝）
   - 分享流程
   - WebView 加载和交互
4）性能测试：
   - 启动时间必须 < 2 秒
   - 内存占用不超过原 OC 版本
   - WebView 加载性能基准测试
5）使用 XCTest 框架，可选 Quick/Nimble 提高可读性。

2.17 文档和注释

指令：完善项目文档。
1）为所有 public 接口添加文档注释；
2）更新 README.md 说明项目结构；
3）创建 ARCHITECTURE.md 说明架构设计；
4）编写 API.md 记录所有 JSBridge 接口；
5）创建 MIGRATION.md 记录升级注 意事项；
6）在关键代码处添加实现说明注释。

3. 测试编译（用户完成）

4. 测试运行（用户完成）

5. 测试功能完整性（用户完成）

6. 构建（用户完成）
