# 项目简介与目录说明

## 项目概述
这是iOS应用的代码库，用于根据不同的manifest资源包打包不同的app，基于 WebView 的混合开发应用，使用 Objective-C 开发。
当前资源包要打包的app：在局。

### 基本信息
- **项目名称**: 在局 (zaiju)
- **Bundle ID**: com.zaiju
- **开发语言**: Objective-C
- **架构模式**: MVC + WebView混合开发
- **最低iOS版本**: iOS 15.0
- **包管理工具**: CocoaPods
- **当前版本**: 1.0.15

### 项目定位
在局APP是一个基于WebView的混合开发应用，通过原生壳承载H5页面，实现跨平台的业务功能。该应用采用WKWebView作为核心渲染引擎，通过JavaScript Bridge实现原生与H5的双向通信。

### 技术特点
1. **混合开发架构**: 原生提供基础能力，H5承载业务逻辑
2. **模块化JSBridge**: 2025年重构后的模块化JavaScript桥接架构
3. **统一管理器模式**: 版本、错误码、性能、认证等统一管理
4. **自定义导航体系**: 完全自定义的导航栏和转场动画
5. **延迟加载优化**: WebView延迟创建，优化启动性能



## manifest资源包架构说明

这个项目的核心设计理念是：**Native容器 + manifest资源包 = 独立应用**

### 架构特点
1. **Native作为容器**：iOS原生代码仅提供WebView容器和基础能力（如相机、定位、支付等）
2. **H5承载业务**：所有业务逻辑、界面展示都由manifest中的H5资源实现
3. **本地资源加载**：所有H5页面都从本地manifest目录加载，无需网络请求
4. **资源包替换机制**：通过替换manifest目录即可打包成不同的应用

### manifest目录结构
```
manifest/
├── app.html                    # 主模板文件，包含应用配置
├── pages/                      # 所有H5页面
│   ├── home/                  # 首页模块
│   ├── shop/                  # 商城模块
│   └── ...                    # 其他业务模块
└── static/                    # 静态资源
    ├── app/xz-app.js         # 应用核心JS
    └── app/webviewbridge.js  # JS桥接文件
```

### 资源加载流程
1. Native读取`manifest/app.html`作为模板
2. 设置baseURL为manifest目录，确保资源正确加载
3. H5通过相对路径访问pages、static等资源
4. JS通过`window.xzBridge`调用Native功能

### 打包不同应用的方法
1. 准备新的manifest资源包（包含该应用的所有H5资源）
2. 修改`app.html`中的配置（domain、xzAppId等）
3. 替换iOS工程中的manifest目录
4. 修改iOS原生配置（Bundle ID、应用名称、图标等）
5. 重新编译打包

**重要提示**：修改代码时，要明确区分是修改Native容器功能还是H5业务逻辑。大部分业务需求应该在manifest中的H5代码实现，由另一位开发人员解决。

## 核心技术栈

### 原生技术
- **语言**: Objective-C
- **UI框架**: UIKit
- **网络请求**: AFNetworking
- **图片加载**: SDWebImage
- **自动布局**: Masonry
- **刷新控件**: MJRefresh
- **JSON解析**: JSONModel
- **钥匙串存储**: SAMKeychain

### 第三方SDK
- **地图定位**: 高德地图SDK (AMap3DMap, AMapLocation, AMapSearch)
- **统计分析**: 友盟SDK (UMCommon, UMAPM)
- **消息推送**: 友盟推送 (UMPush)
- **社交分享**: 友盟分享 (UMShare) + 原生微信/QQ/微博SDK
- **支付**: 支付宝SDK + 微信支付
- **图片上传**: 七牛云SDK

### H5技术
- **框架**: jQuery
- **图表**: Highcharts, Chart.js
- **轮播**: Swiper
- **富文本编辑器**: CKEditor
- **组件系统**: 自定义Web组件

## 项目结构说明

### 根目录结构
```
zaijuapp/
├── CLAUDE.md                      # AI开发助手配置文件
├── ExportOptions.plist            # 打包导出配置
├── Podfile                        # CocoaPods依赖配置
├── Podfile.lock                   # 依赖版本锁定文件
├── Pods/                          # CocoaPods依赖库目录
├── XZVientiane.xcodeproj/         # Xcode项目文件
├── XZVientiane.xcworkspace/       # Xcode工作区文件
├── XZVientiane/                   # 主工程目录
├── XZVientianeTests/              # 单元测试目录
├── XZVientianeUITests/            # UI测试目录
├── build/                         # 构建输出目录
├── success.md                     # 成功状态执行脚本
└── update.md                      # 更新状态执行脚本
```

### 主工程目录结构 (XZVientiane/)

#### 1. 应用配置
```
AppDelegate/                       # 应用程序入口
├── AppDelegate.h/m                # 应用生命周期管理
└── TCConfig.h                     # 全局配置头文件

Info.plist                         # 应用信息配置
ClientSetting.plist                # 客户端设置
PublicSetting.plist                # 公共设置
appInfo.json                       # 应用信息JSON配置
shareInfo.json                     # 分享相关配置
XZVientiane.entitlements           # 应用权限配置
```

#### 2. 资源文件
```
Assets.xcassets/                   # 图片资源目录
├── AppIcon.appiconset/            # 应用图标
├── LaunchImage.launchimage/       # 启动图片
└── 其他图片资源/                  # 各类功能图标

manifest/                          # H5资源包
├── app.html                       # 主页面模板
└── static/                        # 静态资源
    ├── app/                       # 应用配置
    ├── js/                        # JavaScript文件
    ├── css/                       # 样式文件
    ├── components/                # Web组件
    └── plugins/                   # 插件资源

icomoon.ttf                        # 图标字体文件
iconfont.ttf                       # 图标字体文件
```

#### 3. 基础框架 (XZBase/)
```
XZBase/
├── BaseController/                # 基础控制器
│   ├── XZViewController.*         # 基础视图控制器
│   ├── XZNavigationController.*   # 自定义导航控制器
│   ├── XZTabBarController.*       # 自定义标签栏控制器
│   ├── XZWKWebViewBaseController.* # WebView基础控制器
│   ├── XZNavBar.*                 # 自定义导航栏
│   └── TYCutImageViewController.* # 图片裁剪控制器
├── BaseHead/                      # 基础头文件
├── BaseManager/                   # 基础管理器
│   ├── BaseFileManager.*          # 文件管理
│   ├── EGOCache.*                 # 缓存管理
│   ├── HTMLCache.*                # HTML缓存
│   └── Helper.*                   # 工具助手
├── BaseModel/                     # 基础数据模型
└── BaseView/                      # 基础视图组件
    ├── CustomTabBar.*             # 自定义TabBar
    ├── ProgressView.*             # 进度条视图
    └── XZTableViewCell.*          # 基础表格单元格
```

#### 4. 业务基础组件 (ClientBase/)
```
ClientBase/
├── BaseController/                # 业务控制器
│   ├── CFJClientH5Controller.*    # H5页面控制器
│   ├── CFJScanViewController.*    # 扫码控制器
│   ├── HTMLWebViewController.*    # 网页控制器
│   └── NetworkNoteViewController.* # 网络错误提示
├── JSBridge/                      # JS桥接模块(新架构)
│   ├── JSActionHandler.*          # 处理器基类
│   ├── JSActionHandlerManager.*   # 处理器管理器
│   └── Handlers/                  # 具体处理器
│       ├── JSUIHandler.*          # UI功能
│       ├── JSNavigationHandler.*  # 导航功能
│       ├── JSLocationHandler.*    # 定位功能
│       ├── JSMediaHandler.*       # 媒体功能
│       ├── JSNetworkHandler.*     # 网络请求
│       ├── JSPaymentHandler.*     # 支付功能
│       ├── JSShareHandler.*       # 分享功能
│       ├── JSUserHandler.*        # 用户功能
│       ├── JSDeviceHandler.*      # 设备功能
│       ├── JSFileHandler.*        # 文件操作
│       ├── JSMessageHandler.*     # 消息功能
│       └── JSPageLifecycleHandler.* # 生命周期
├── BaseDefine/                    # 基础定义
│   ├── CLNotificationDefine.*     # 通知定义
│   ├── CLUserDefaultDefine.*      # 用户默认值定义
│   └── SystemDefine.h             # 系统定义
├── BaseManager/                   # 业务管理器
│   ├── CLFileManager.*            # 文件管理
│   ├── ManageCenter.*             # 管理中心
│   └── XZPackageH5.*              # H5包管理
├── BaseModel/                     # 业务数据模型
├── BaseNet/                       # 网络请求
│   ├── ClientJsonRequestManager.* # JSON请求管理
│   └── ClientNetInterface.*       # 网络接口定义
└── BaseView/                      # 业务视图组件
    └── LoadingView.*              # 加载视图
```

#### 5. 公共组件 (Common/)
```
Common/
├── Auth/                          # 认证管理
│   └── XZAuthenticationManager.*  # 统一认证管理器
├── ErrorCode/                     # 错误码管理
│   └── XZErrorCodeManager.*       # 错误码管理器
├── Utilities/                     # 工具类
│   └── XZiOSVersionManager.*      # iOS版本管理器
└── WebView/                       # WebView管理
    └── XZWebViewPerformanceManager.* # 性能管理器
```

#### 6. 业务模块 (Module/)
```
Module/
├── BadgeView/                     # 徽章视图组件
├── EVNCustomSearchBar/            # 自定义搜索栏
├── MOFSPickerManager/             # 选择器管理
│   ├── MOFSAddressPickerView.*    # 地址选择器
│   ├── MOFSDatePicker.*           # 日期选择器
│   └── city.json                  # 城市数据
├── YBPopupMenu/                   # 弹出菜单
└── ZZCircleProgress/              # 圆形进度条
```

#### 7. 分类扩展 (Category/)
```
Category/
├── NSArray/                       # 数组扩展
├── NSDictionary/                  # 字典扩展
├── NSString/                      # 字符串扩展
├── UIBarButtonItem/               # 导航按钮扩展
├── UIButton/                      # 按钮扩展
├── UIColor/                       # 颜色扩展
├── UIImage/                       # 图片扩展
├── UITabbar/                      # TabBar扩展
├── UIView/                        # 视图扩展
└── WKWebView/                     # WebView扩展
```

#### 8. 第三方桥接 (ThirdParty/)
```
ThirdParty/
├── WKWebViewJavascriptBridge.*    # JS桥接核心
├── WebViewJavascriptBridgeBase.*  # 桥接基类
└── WebViewJavascriptBridge_JS.*   # JS代码
```

#### 9. 工具类 (Tools/)
```
Tools/
└── Reachability.*                 # 网络状态监测
```

#### 10. 定义文件 (Define/)
```
Define/
├── DCConsts.*                     # 常量定义
├── XZBaseHead.h                   # 基础头文件
├── XZFunctionDefine.h             # 函数宏定义
└── XZIcomoonDefine.*              # 图标字体定义
```

## 关键文件说明

### 1. 入口文件
- `main.m`: 应用程序入口
- `AppDelegate.m`: 应用生命周期管理，初始化第三方SDK

### 2. 核心控制器
- `XZViewController`: 所有控制器的基类，管理自定义导航栏
- `XZWKWebViewBaseController`: WebView控制器基类，处理H5页面加载
- `CFJClientH5Controller`: 具体的业务实现，处理JS-Native交互

### 3. 导航系统
- `XZNavigationController`: 自定义导航控制器，实现转场动画
- `XZTabBarController`: 自定义TabBar控制器，动态加载Tab配置
- `XZNavBar`: 自定义导航栏视图

### 4. JSBridge系统
- `JSActionHandlerManager`: JS调用的统一入口和路由
- `JSActionHandler`: 处理器基类，定义标准接口
- 各种Handler: 具体功能实现，如UI、网络、支付等

### 5. 配置文件
- `Info.plist`: iOS应用标准配置
- `ClientSetting.plist`: 服务器地址、API密钥等配置
- `PublicSetting.plist`: URL Scheme等公共配置
- `appInfo.json`: TabBar配置、主题色等
- `shareInfo.json`: 第三方分享SDK配置

### 6. 资源文件
- `manifest/`: H5资源包，包含HTML、JS、CSS等
- `Assets.xcassets/`: 原生图片资源
- 字体文件: 图标字体支持

## 架构特点

### 1. 分层架构
- **基础层**: XZBase提供基础控制器和组件
- **业务层**: ClientBase提供业务相关的基础功能
- **模块层**: Module提供独立的功能模块
- **工具层**: Category和Tools提供辅助功能

### 2. 继承体系
```
UIViewController
    └── XZViewController
        └── XZWKWebViewBaseController
            └── CFJClientH5Controller
```

### 3. JSBridge模块化
- 将原本500+行的jsCallObjc方法拆分成多个独立Handler
- 每个Handler负责特定功能领域
- 通过Manager统一管理和路由

### 4. 统一管理器
- iOS版本管理器: 统一处理版本判断
- 错误码管理器: 标准化错误处理
- 性能管理器: 监控WebView性能
- 认证管理器: 统一处理登录认证

## 开发注意事项

### 1. 代码规范
- 使用Objective-C开发，保持代码现代性
- 避免使用console.log调试，使用alert测试
- 添加的日志格式: "在局Claude Code[测试内容]+日志内容"
- 测试完成后删除无意义的日志

### 2. WebView相关
- WebView在viewDidAppear中延迟创建
- iOS 18需要处理viewDidAppear多次调用问题
- JavaScript调用使用window.xzBridge.callHandler

### 3. 第三方SDK
- 微信AppID: wx10a321f7fbdd6023
- 友盟AppKey: 5db314c23fc195be40000ac6
- 需要在对应平台配置相关参数

### 4. 构建部署
- 使用CocoaPods管理依赖
- 构建脚本: Test/Scripts/build.sh
- 最低支持iOS 15.0

## 总结

APP是一个典型的WebView混合开发应用，具有清晰的分层架构和模块化设计。项目经过2025年的大规模重构，实现了JSBridge模块化、统一管理器等现代化架构改进。在迁移到Swift时，需要重点关注语言特性差异、第三方库兼容性和JSBridge的实现方式。建议采用渐进式迁移策略，确保应用的稳定性和功能完整性。