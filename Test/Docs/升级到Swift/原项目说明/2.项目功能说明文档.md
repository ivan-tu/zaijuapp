# 在局App项目功能说明文档

> 本文档用于记录在局App的完整功能实现，为未来升级到Swift提供参考

## 目录

- [项目概述](#项目概述)
- [技术架构](#技术架构)
- [JavaScript Bridge功能模块](#javascript-bridge功能模块)
  - [导航管理（JSNavigationHandler）](#导航管理jsnavigationhandler)
  - [UI交互（JSUIHandler）](#ui交互jsuihandler)
  - [支付功能（JSPaymentHandler）](#支付功能jspaymenthandler)
  - [分享功能（JSShareHandler）](#分享功能jssharehandler)
  - [定位功能（JSLocationHandler）](#定位功能jslocationhandler)
  - [媒体功能（JSMediaHandler）](#媒体功能jsmediahandler)
  - [网络请求（JSNetworkHandler）](#网络请求jsnetworkhandler)
  - [用户管理（JSUserHandler）](#用户管理jsuserhandler)
  - [设备信息（JSDeviceHandler）](#设备信息jsdevicehandler)
  - [文件操作（JSFileHandler）](#文件操作jsfilehandler)
  - [其他功能（JSMiscHandler）](#其他功能jsmischandler)
  - [页面生命周期（JSPageLifecycleHandler）](#页面生命周期jspagelifecyclehandler)
- [原生功能模块](#原生功能模块)
  - [WebView管理](#webview管理)
  - [网络请求封装](#网络请求封装)
  - [数据存储](#数据存储)
  - [用户认证](#用户认证)
  - [UI组件库](#ui组件库)
- [第三方SDK集成](#第三方sdk集成)
- [数据交互协议](#数据交互协议)
- [特色功能实现](#特色功能实现)

## 项目概述

在局App是一个基于WebView的iOS混合开发应用，主要特点：

- **Bundle ID**: com.zaiju
- **最低iOS版本**: iOS 15.0
- **开发语言**: Objective-C
- **包管理**: CocoaPods
- **架构模式**: MVC + WebView混合开发
- **JS Bridge**: WKWebViewJavascriptBridge

项目通过WKWebView加载H5页面，Native端提供各种能力支持，通过JavaScript Bridge实现双向通信。

## 技术架构

### 继承关系

```
UIViewController
  └── XZViewController (基础功能封装)
      └── XZWKWebViewBaseController (WebView基类)
          └── CFJClientH5Controller (业务实现)
```

### 核心架构组件

1. **JSActionHandlerManager**: JS Bridge处理器管理中心（单例）
2. **JSActionHandler**: 所有JS处理器的基类
3. **xzBridge**: JavaScript端调用原生功能的桥接对象
4. **WKWebViewJavascriptBridge**: 第三方桥接框架

## JavaScript Bridge功能模块

### 导航管理（JSNavigationHandler）

负责页面导航相关的所有功能。

#### navigateTo - 页面跳转
```javascript
// 参数：
{
  url: "页面URL",
  closeCurrent: "true/false", // 是否关闭当前页
  params: {} // 额外参数
}
```
实现逻辑：
- 支持内部H5页面跳转（创建新的WebView控制器）
- 支持外部链接跳转（使用SFSafariViewController）
- 支持携带参数传递

#### navigateBack - 返回上一页
```javascript
// 参数：
{
  delta: 1 // 返回层级数，默认1
}
```
实现逻辑：
- 支持返回指定层级
- 自动处理导航栈

#### reLaunch - 重启应用到首页
```javascript
// 参数：
{
  url: "目标URL" // 可选，默认首页
}
```
实现逻辑：
- 清空导航栈
- 重新加载首页

#### 其他导航功能
- `switchTab`: 切换底部Tab（通过selectedIndex）
- `closeCurrentTab`: 关闭当前Tab页
- `setNavigationBarTitle`: 设置导航栏标题
- `hideNavationbar`: 隐藏导航栏
- `showNavationbar`: 显示导航栏

### UI交互（JSUIHandler）

处理所有UI相关的交互功能。

#### showModal - 模态对话框
```javascript
// 参数：
{
  title: "标题",
  content: "内容",
  showCancel: true,
  cancelText: "取消",
  cancelColor: "#000000",
  confirmText: "确定",
  confirmColor: "#3CC51F"
}
```
实现：使用UIAlertController

#### showToast - Toast提示
```javascript
// 参数：
{
  title: "提示内容",
  icon: "success/error/loading/none",
  duration: 2000, // 毫秒
  mask: false // 是否显示遮罩
}
```
实现：使用MBProgressHUD

#### 选择器组件
1. **fancySelect** - 单选选择器
   - 实现：UIPickerView
   - 支持自定义选项数组

2. **areaSelect** - 三级地区选择
   - 实现：MOFSAddressPickerView
   - 支持省市区三级联动

3. **dateSelect** - 日期选择器
   - 实现：UIDatePicker
   - 支持年月日选择

4. **timeSelect** - 时间选择器
   - 实现：UIDatePicker
   - 支持时分选择

#### Tab角标管理
- `setTabBarBadge`: 设置Tab角标数字
- `removeTabBarBadge`: 移除Tab角标
- `showTabBarRedDot`: 显示Tab红点
- `hideTabBarRedDot`: 隐藏Tab红点

### 支付功能（JSPaymentHandler）

#### weixinPay - 微信支付
```javascript
// 参数：
{
  partnerId: "商户号",
  prepayId: "预支付ID",
  nonceStr: "随机字符串",
  timeStamp: "时间戳",
  package: "扩展字段",
  sign: "签名"
}
```
实现：
- 集成微信SDK (WXApi)
- 处理支付回调
- 返回支付结果

#### aliPay - 支付宝支付
```javascript
// 参数：
{
  payInfo: "支付信息字符串"
}
```
实现：
- 集成支付宝SDK (AlipaySDK)
- 处理URL Scheme回调

### 分享功能（JSShareHandler）

#### share - 分享功能
```javascript
// 参数：
{
  title: "分享标题",
  content: "分享描述",
  url: "分享链接",
  imageUrl: "图片URL",
  type: "weixin/timeline/qq等"
}
```
实现：
- 集成友盟分享SDK
- 支持微信、朋友圈、QQ等平台
- 自动处理图片下载和压缩

#### copyLink - 复制链接
```javascript
// 参数：
{
  text: "要复制的文本"
}
```
实现：使用UIPasteboard

### 定位功能（JSLocationHandler）

#### getLocation - 获取当前位置
```javascript
// 返回数据：
{
  latitude: 23.123456,
  longitude: 113.123456,
  address: "详细地址",
  city: "城市",
  province: "省份"
}
```
实现：
- 集成高德地图SDK
- 处理定位权限
- 逆地理编码获取地址

#### selectLocation - 地图选点
```javascript
// 参数：
{
  latitude: 23.123456, // 初始位置
  longitude: 113.123456
}
```
实现：
- 打开地图选择页面
- 支持搜索和拖动选点
- 返回选中位置信息

### 媒体功能（JSMediaHandler）

#### previewImage - 图片预览
```javascript
// 参数：
{
  current: "当前图片URL",
  urls: ["图片URL数组"]
}
```
实现：
- 使用YBImageBrowser
- 支持手势缩放
- 支持保存到相册

#### QRScan - 二维码扫描
```javascript
// 返回数据：
{
  result: "扫描结果"
}
```
实现：
- 使用AVFoundation
- 支持相册选择二维码
- 自动处理相机权限

### 网络请求（JSNetworkHandler）

#### request - 发起网络请求
```javascript
// 参数：
{
  url: "请求地址",
  method: "GET/POST",
  data: {}, // 请求参数
  header: {}, // 请求头
  dataType: "json",
  timeout: 30000
}
```
实现：
- 基于AFNetworking封装
- 支持自定义headers
- 统一错误处理
- 支持超时控制

### 用户管理（JSUserHandler）

#### userLogin - 用户登录
```javascript
// 参数：
{
  username: "用户名",
  password: "密码"
}
```
实现：
- 调用登录API
- 存储用户信息和Token
- 更新登录状态

#### weixinLogin - 微信登录
```javascript
// 无参数，自动调起微信授权
```
实现：
- 调起微信授权
- 获取授权码
- 服务端换取用户信息

### 设备信息（JSDeviceHandler）

#### 设备检测功能
- `hasWx`: 检测是否安装微信
- `isiPhoneX`: 检测是否为iPhone X系列设备
- `nativeGet`: 获取本地存储的文件内容

### 文件操作（JSFileHandler）

#### chooseFile - 选择文件
```javascript
// 参数：
{
  count: 9, // 最大选择数量
  sizeType: ["original", "compressed"],
  sourceType: ["album", "camera"]
}
```
实现：
- 使用TZImagePickerController
- 支持多选和压缩
- 返回本地文件路径

#### uploadFile - 上传文件
```javascript
// 参数：
{
  filePath: "本地文件路径",
  name: "文件字段名",
  formData: {} // 额外表单数据
}
```
实现：
- 集成七牛SDK
- 支持进度回调
- 自动获取上传Token

### 其他功能（JSMiscHandler）

- `reload`: 重新加载当前页面
- `customReturn`: 自定义返回操作（可拦截返回事件）
- `openQRCode`: 显示应用二维码
- `nativeLog`: 输出日志到原生控制台

### 页面生命周期（JSPageLifecycleHandler）

管理H5页面的生命周期事件：
- `viewWillAppear`: 页面即将显示
- `viewDidAppear`: 页面已经显示
- `viewWillDisappear`: 页面即将消失
- `viewDidDisappear`: 页面已经消失

## 原生功能模块

### WebView管理

#### XZWKWebViewBaseController
- WKWebView的创建和配置
- JavaScript Bridge的初始化
- Cookie同步管理
- 进度条显示
- 错误页面处理

#### 性能优化
- 延迟创建WebView（viewDidAppear）
- HTML离线缓存机制
- 资源预加载
- 内存警告处理

### 网络请求封装

#### XZNetworkManager
基于AFNetworking的网络层封装：
- 统一的请求接口
- 请求/响应拦截器
- 错误码统一处理
- 网络状态监听

### 数据存储

#### 存储方案
1. **NSUserDefaults**: 用户偏好设置
2. **Keychain**: 敏感信息（如Token）
3. **文件存储**: 大文件和缓存数据
4. **SQLite**: 结构化数据（未使用）

#### CLFileManager
文件管理工具类：
- 文件的增删改查
- 目录管理
- 缓存清理

### 用户认证

#### XZAuthenticationManager
统一的认证管理：
- Token的存储和刷新
- 登录状态维护
- 自动登录处理
- 会话超时管理

### UI组件库

#### 自定义导航栏
- 支持搜索框集成
- 支持自定义按钮
- 支持渐变效果
- 支持下拉刷新

#### MOFSPickerManager
各类选择器的封装：
- 地区选择器（三级联动）
- 日期时间选择器
- 单选/多选选择器

#### 图片浏览器
基于YBImageBrowser：
- 支持手势操作
- 支持保存和分享
- 支持视频播放

## 第三方SDK集成

### 支付相关
1. **微信SDK**
   - AppID: wx10a321f7fbdd6023
   - 支持支付、登录、分享

2. **支付宝SDK**
   - 支持支付功能
   - URL Scheme配置

### 地图定位
**高德地图SDK**
- AMapFoundation：基础库
- AMapLocation：定位服务
- AMapSearch：搜索服务
- AMap3DMap：地图显示

### 统计推送
**友盟SDK**
- AppKey: 5db314c23fc195be40000ac6
- UMCommon：基础统计
- UMPush：推送服务
- UMShare：社交分享

### 其他SDK
- **七牛云存储**：文件上传
- **MBProgressHUD**：加载提示
- **TZImagePickerController**：图片选择
- **YBImageBrowser**：图片浏览

## 数据交互协议

### JS调用Native

```javascript
window.xzBridge.callHandler('action', {
    action: 'actionName',
    data: {
        // 具体参数
    }
}, function(response) {
    // 处理回调
});
```

### 回调数据格式

```javascript
// 成功回调
{
    success: "true",
    data: {
        // 返回数据
    }
}

// 失败回调
{
    success: "false",
    errorMessage: "错误信息",
    errorCode: "错误码"
}
```

### Native调用JS

```objective-c
[self.bridge callHandler:@"jsHandlerName" 
                  data:@{@"key": @"value"} 
          responseCallback:^(id responseData) {
    // 处理JS返回
}];
```

## 特色功能实现

### 1. 模块化JS Bridge架构

将原本集中的jsCallObjc方法（500+行）拆分为13个独立的Handler模块：
- 每个Handler负责特定领域的功能
- 通过Manager统一注册和分发
- 易于维护和扩展

### 2. 离线资源包机制

支持H5资源的离线使用：
- manifest资源包下载和更新
- 版本控制和差量更新
- 自动缓存管理

### 3. 统一错误处理

XZErrorCodeManager提供统一的错误码管理：
- 标准化错误码定义
- 友好的错误提示
- 错误日志收集

### 4. iOS版本兼容

XZiOSVersionManager处理系统版本差异：
- API兼容性检查
- 功能降级处理
- 版本特定bug修复

### 5. 安全机制

- HTTPS强制使用
- Token自动续期
- 敏感信息加密存储
- JS注入攻击防护

### 6. 性能优化

- WebView复用池
- 图片懒加载
- 内存泄漏监控
- 启动时间优化

## 升级Swift注意事项

1. **桥接处理**：需要创建Objective-C桥接头文件
2. **第三方库**：部分SDK可能需要寻找Swift版本
3. **协议转换**：Delegate模式可考虑使用Swift的协议
4. **可选类型**：充分利用Swift的可选类型特性
5. **错误处理**：使用Swift的Error协议重构错误处理
6. **闭包语法**：Block转换为Swift闭包
7. **内存管理**：注意循环引用，使用weak/unowned

---

本文档基于当前代码库整理，涵盖了在局App的所有主要功能实现。在升级到Swift时，建议保持现有的模块化架构，逐步进行语言层面的迁移。