# 真正的分页加载实现方案

## 实现原理

基于 PhotoKit 的特性：**PHFetchResult 本身就是惰性加载的**。它不会真正获取照片数据，直到你请求某一个具体的对象。

## 关键改动

### 1. 移除预加载所有照片的逻辑

```objc
// 原来的做法：一次性转换所有 PHAsset 为 TZAssetModel
[[TZImageManager manager] getAssetsFromFetchResult:self->_model.result completion:^(NSArray<TZAssetModel *> *models) {
    self->_models = [NSMutableArray arrayWithArray:models];
    [self initSubviews];
}];

// 现在的做法：直接使用 PHFetchResult，不预先创建 models
self->_models = nil;
[self initSubviews];
```

### 2. 修改数据源方法

#### numberOfItemsInSection
```objc
- (NSInteger)collectionView:(UICollectionView *)collectionView numberOfItemsInSection:(NSInteger)section {
    // 使用 PHFetchResult 的 count，而不是 _models.count
    NSInteger photoCount = _model.result ? _model.result.count : (_models ? _models.count : 0);
    if (_showTakePhotoBtn) {
        return photoCount + 1;
    }
    return photoCount;
}
```

#### cellForItemAtIndexPath
```objc
// 按需创建 TZAssetModel
if (_models && modelIndex < _models.count) {
    // 如果已经有缓存的 models，使用缓存
    model = _models[modelIndex];
} else if (_model.result && modelIndex < _model.result.count) {
    // 否则从 PHFetchResult 按需创建
    PHAsset *asset = [_model.result objectAtIndex:modelIndex];
    TZAssetModelMediaType type = [[TZImageManager manager] getAssetType:asset];
    model = [TZAssetModel modelWithAsset:asset type:type];
    
    // 检查是否已选中
    NSString *assetId = [[TZImageManager manager] getAssetIdentifier:asset];
    if ([tzImagePickerVc.selectedAssetIds containsObject:assetId]) {
        model.isSelected = YES;
    }
}
```

### 3. 适配其他使用 _models 的地方

所有原来使用 `_models.count` 的地方都改为：
```objc
NSInteger photoCount = _model.result ? _model.result.count : (_models ? _models.count : 0);
```

## 优势

1. **无数量限制**：可以显示所有照片，不再限制为 5000 张
2. **内存效率高**：只为可见的 cell 创建 TZAssetModel
3. **加载速度快**：初始加载几乎瞬间完成
4. **滚动流畅**：利用 UICollectionView 的重用机制

## 性能对比

| 指标 | 原方案（限制5000张） | 新方案（真正分页） |
|------|---------------------|-------------------|
| 初始加载时间 | 5-10秒 | <0.1秒 |
| 内存占用 | 高（创建5000个model） | 低（只创建可见的model） |
| 可显示照片数 | 最多5000张 | 无限制 |
| 用户体验 | 需要等待加载 | 立即可用 |

## 注意事项

1. **选中状态管理**：由于使用懒加载，选中状态需要在 cellForItemAtIndexPath 中动态检查
2. **缓存策略**：可以考虑缓存已创建的 TZAssetModel，避免重复创建
3. **图片加载**：TZAssetCell 本身已经实现了异步图片加载，配合分页加载效果更好

## 后续优化建议

1. **实现 PHImageCachingManager**：预缓存即将显示的图片缩略图
2. **添加滚动性能监控**：监控 FPS，确保流畅度
3. **智能预加载**：根据滚动速度和方向预测需要加载的内容