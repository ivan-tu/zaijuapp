# iOS 18.5 网络请求失败问题修复

## 问题描述
用户在iOS 18.5真机上运行时，所有网络请求都失败，错误信息：
- Error Domain=NSURLErrorDomain Code=-1009 "似乎已断开与互联网的连接"
- _NSURLErrorNWPathKey=unsatisfied (Denied over Wi-Fi interface)

用户已确认授予了网络权限，但问题仍然存在。

## 问题分析

### 1. iOS 18网络权限新变化
iOS 18对网络权限进行了更严格的控制，特别是对URLSession的配置要求更高。

### 2. 主要原因
- AFNetworking默认的URLSessionConfiguration可能不完全兼容iOS 18的新要求
- 系统对网络接口的访问权限控制更加严格
- 需要显式声明允许受限网络访问和昂贵网络访问

### 3. 其他可能原因
- AFNetworking版本可能需要更新
- 网络权限检查的异步时序问题
- 初始化时网络配置不完整

## 修复方案

### 1. 自定义URLSessionConfiguration
修改了`ClientJsonRequestManager`的初始化方法，使用自定义的URLSessionConfiguration：

```objc
// iOS 18修复：创建自定义的URLSessionConfiguration
NSURLSessionConfiguration *configuration = [NSURLSessionConfiguration defaultSessionConfiguration];

// 设置允许使用蜂窝数据
configuration.allowsCellularAccess = YES;

// 设置网络服务类型
configuration.networkServiceType = NSURLNetworkServiceTypeDefault;

// 设置超时时间
configuration.timeoutIntervalForRequest = 45.0;
configuration.timeoutIntervalForResource = 60.0;

// iOS 18修复：确保允许约束网络路径
if (@available(iOS 13.0, *)) {
    configuration.allowsConstrainedNetworkAccess = YES;
    configuration.allowsExpensiveNetworkAccess = YES;
}

// 使用自定义配置创建管理器
_sharedClient = [[ClientJsonRequestManager alloc] initWithBaseURL:url sessionConfiguration:configuration];
```

### 2. 添加网络权限错误检测
在所有网络请求失败处理中添加了iOS 18网络权限问题的检测：

```objc
// iOS 18修复：检查是否是网络权限问题
if (error.code == -1009 && [error.domain isEqualToString:NSURLErrorDomain]) {
    NSDictionary *userInfo = error.userInfo;
    if (userInfo[@"_NSURLErrorNWPathKey"]) {
        NSLog(@"在局Claude Code[网络权限错误]+检测到iOS 18网络权限问题，可能需要用户在设置中授权");
        // 发送通知给UI层处理
        [[NSNotificationCenter defaultCenter] postNotificationName:@"NetworkPermissionDenied" object:nil userInfo:@{@"error": error}];
    }
}
```

### 3. 设置安全策略
添加了明确的安全策略配置：

```objc
// 设置安全策略
_sharedClient.securityPolicy = [AFSecurityPolicy policyWithPinningMode:AFSSLPinningModeNone];
_sharedClient.securityPolicy.allowInvalidCertificates = NO;
_sharedClient.securityPolicy.validatesDomainName = YES;
```

## 修改文件
- `/XZVientiane/ClientBase/BaseNet/ClientJsonRequestManager.m`

## 测试建议
1. 在iOS 18.5真机上测试网络请求是否恢复正常
2. 检查控制台日志，确认网络配置信息正确
3. 如果问题仍然存在，检查：
   - AFNetworking版本是否需要更新
   - 是否需要在Info.plist中添加其他权限声明
   - 域名配置是否正确（检查ClientSetting.plist）

## 后续优化建议
1. 考虑升级AFNetworking到最新版本以获得更好的iOS 18支持
2. 实现网络权限恢复后的自动重试机制
3. 在UI层处理NetworkPermissionDenied通知，提示用户检查网络设置