# 网络权限和ATS配置问题修复

## 修改时间
2025-08-01 23:17

## 问题分析

用户反馈首页无法正确显示，日志显示：
1. 所有网络请求失败："似乎已断开与互联网的连接"
2. 错误码 -1009，NSURLErrorDomain
3. Wi-Fi权限被拒绝："nehelper sent invalid result code [1]"
4. 高德地图API请求被ATS阻止

## 问题原因

1. **模拟器网络权限被拒绝**
   - iOS 14+需要本地网络权限描述
   - 模拟器可能缓存了权限拒绝状态

2. **App Transport Security配置不完整**
   - 高德地图API域名未添加到例外列表

## 修复方案

### 1. 添加本地网络权限描述
在Info.plist中添加：
```xml
<key>NSLocalNetworkUsageDescription</key>
<string>"在局"需要访问本地网络来发现附近的设备和提供更好的服务体验。</string>
```

### 2. 完善ATS配置
添加高德地图相关域名到NSExceptionDomains：
```xml
<key>amap.com</key>
<dict>
    <key>NSExceptionAllowsInsecureHTTPLoads</key>
    <true/>
    <key>NSIncludesSubdomains</key>
    <true/>
</dict>
<key>restios.amap.com</key>
<dict>
    <key>NSExceptionAllowsInsecureHTTPLoads</key>
    <true/>
</dict>
<key>dualstack-arestapi.amap.com</key>
<dict>
    <key>NSExceptionAllowsInsecureHTTPLoads</key>
    <true/>
</dict>
```

### 3. 重置模拟器
```bash
# 完全重置模拟器
xcrun simctl shutdown all
xcrun simctl erase all

# 清理Xcode缓存
rm -rf ~/Library/Developer/Xcode/DerivedData/XZVientiane-*
```

## 测试要点

1. 重新编译并运行应用
2. 首次启动时允许本地网络权限
3. 检查网络请求是否正常
4. 验证首页是否正确加载

## 注意事项

- 这不是代码问题，而是权限配置问题
- 真机测试通常不会遇到此问题
- 确保在Settings中允许应用的网络权限