# LoadingView和首页加载详细分析

## 1. LoadingView控制逻辑

### LoadingView的显示时机
- **位置**: AppDelegate.m的`application:didFinishLaunchingWithOptions:`方法
- **时机**: App启动后立即显示
- **代码**:
```objc
// 显示加载界面（使用统一管理）
[self showGlobalLoadingView];
```

### LoadingView的实现
- **类**: `LoadingView` (ClientBase/BaseView/LoadingView.m)
- **内容**: 显示启动图，覆盖整个屏幕
- **作用**: 在App初始化和首页加载期间提供视觉反馈

### LoadingView的移除条件和时机

有三个主要移除时机：

1. **showTabviewController通知触发** (XZTabBarController.m)
   ```objc
   //首页加载完成后移除LoadingView
   [[NSNotificationCenter defaultCenter] addObserverForName:@"showTabviewController" 
                                                     object:nil 
                                                      queue:[NSOperationQueue mainQueue] 
                                                 usingBlock:^(NSNotification *note) {
       [appDelegate removeGlobalLoadingViewWithReason:@"首页pageReady完成"];
   }];
   ```

2. **首页pageReady触发** (XZWKWebViewBaseController.m)
   ```objc
   - (void)ensureLoadingViewRemovedBeforeDataRequests {
       if (!appDelegate.isLoadingViewRemoved) {
           [appDelegate removeGlobalLoadingViewWithReason:@"首页pageReady完成"];
       }
   }
   ```

3. **10秒超时机制** (AppDelegate.m)
   ```objc
   dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(10.0 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
       if (!self.hasInitialized) {
           if (!self.networkRestricted) {
               [self removeGlobalLoadingViewWithReason:@"初始化超时，网络正常"];
           }
       }
   });
   ```

## 2. 网络请求处理

### 网络配置（ClientJsonRequestManager.m）
- **超时设置**:
  - 请求超时: 45秒
  - 资源超时: 60秒
- **iOS 18特殊处理**:
  - 允许蜂窝数据访问
  - 允许约束网络路径
  - 允许昂贵网络访问

### 首页URL
- **域名**: https://zaiju.com
- **首页地址**: https://zaiju.com/p/home/index/index

### 网络重试机制
- 使用AFNetworking的缓存机制
- 无网络时优先使用本地缓存

## 3. WKWebView配置

### 缓存策略
- **数据存储**: 使用默认的WKWebsiteDataStore
- **缓存策略**: NSURLRequestUseProtocolCachePolicy（默认协议缓存）

### WebView创建配置（XZWKWebViewBaseController.m）
```objc
- (WKWebViewConfiguration *)createOptimizedWebViewConfiguration {
    WKWebViewConfiguration *configuration = [[WKWebViewConfiguration alloc] init];
    configuration.allowsInlineMediaPlayback = YES;
    configuration.mediaTypesRequiringUserActionForPlayback = WKAudiovisualMediaTypeNone;
    configuration.websiteDataStore = [WKWebsiteDataStore defaultDataStore];
    return configuration;
}
```

### 离线缓存
- 无特殊的离线包机制
- 依赖WKWebView默认缓存

## 4. XZWebViewPerformanceManager分析

### 功能实现
该类提供了完整的WebView性能优化功能：

1. **WebView池化**
   - 预创建2个WebView实例
   - 支持获取预热的WebView
   - 支持回收WebView到池中

2. **性能优化脚本**
   - 禁用长按选择
   - 优化滚动性能
   - 图片懒加载

3. **共享ProcessPool**
   - 所有WebView共享同一个ProcessPool
   - 可以共享Cookie和缓存

### 使用情况
**问题**: 虽然在AppDelegate中调用了`preloadWebViewResources`，但实际的WebView创建并未使用池化功能。

```objc
// AppDelegate中调用了预热
[[XZWebViewPerformanceManager sharedManager] preloadWebViewResources];

// 但XZWKWebViewBaseController中仍然直接创建新的WebView
self.webView = [[WKWebView alloc] initWithFrame:CGRectZero configuration:configuration];
```

## 5. manifest/app.html分析

### 模板大小
- 文件大小: 约2KB
- 包含14个JavaScript文件引用
- 包含3个CSS文件引用

### 加载的资源
```html
<!-- JavaScript文件 -->
static/js/config.js
static/js/jquery.js
static/js/xzp.js
static/js/xzSystem.js
static/js/webApp.js
static/common/xzApp.js
static/common/xzImage.js
static/language/zh-cn.js
static/js/xzParse.js
static/js/app.js
static/js/xzWX.js
static/app/xz-app.js
static/app/webviewbridge.js
static/app/universal-links.js
static/js/fastClick.js
```

### 潜在问题
1. **资源过多**: 14个JS文件可能导致加载延迟
2. **无合并优化**: 每个文件都需要单独请求
3. **同步加载**: 没有使用async或defer属性

## 问题总结

### 主要性能瓶颈

1. **WebView延迟创建**
   - WebView在viewDidAppear才创建
   - 错过了预加载的最佳时机

2. **未使用WebView池**
   - XZWebViewPerformanceManager功能完善但未被使用
   - 每次都创建新的WebView实例

3. **HTML模板每次重新读取**
   - domainOperate每次都从文件系统读取app.html
   - 没有缓存机制

4. **过多的JavaScript资源**
   - 14个独立的JS文件
   - 没有资源合并和压缩

5. **LoadingView移除时机过晚**
   - 等待pageReady信号
   - 应该在内容开始显示时就移除

### 优化建议优先级

1. **高优先级**:
   - 使用XZWebViewPerformanceManager的预热WebView
   - 在viewDidLoad中创建WebView（首页）
   - 缓存HTML模板

2. **中优先级**:
   - 合并JavaScript资源
   - 优化LoadingView移除时机
   - 实现HTML模板预加载

3. **低优先级**:
   - 实现离线包机制
   - 优化网络请求策略
   - 添加资源预加载