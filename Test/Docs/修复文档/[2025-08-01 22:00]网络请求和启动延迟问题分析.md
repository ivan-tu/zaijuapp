# 网络请求和启动延迟问题分析

## 修改时间
2025-08-01 22:00

## 问题分析

### 1. 首页加载延迟（10秒）
- **原因**：启动时多个网络请求失败（错误码-1009）
- **详情**：_NSURLErrorNWPathKey=unsatisfied (Denied over Wi-Fi interface)
- **说明**：这表明网络权限还未完全获取时就开始了网络请求

### 2. Token刷新失败
- **错误信息**："empty appid or appsecret"
- **原因**：ClientSetting.plist中的appId或appSecret配置可能为空或错误

### 3. 内页请求失败
- **错误信息**："缺少必要参数"
- **原因**：第二次请求/activityapi/getActivityDetail时参数变成了空对象

## 修改文件

### 1. ClientSettingModel.m
- 路径：`XZVientiane/ClientBase/BaseModel/ClientSettingModel.m`
- 添加配置加载日志，显示plist路径和内容
- 添加appId和appSecret读取日志

### 2. AppDelegate.m
- 路径：`XZVientiane/AppDelegate/AppDelegate.m`
- 添加网络权限检查开始和结束时间日志
- 添加权限回调状态日志
- 添加超时处理日志

### 3. JSNetworkHandler.m
- 路径：`XZVientiane/ClientBase/JSBridge/Handlers/JSNetworkHandler.m`
- 添加原始请求数据日志
- 特别添加getActivityDetail参数检查日志

## 需要进一步确认的问题

### 1. 配置文件问题
需要检查ClientSetting.plist文件中：
- AppId 和 AppSecret（调试模式）
- formalAppId 和 formalAppSecret（正式模式）
确保这些值不为空

### 2. 网络状态问题
- 当前网络状态一直是-1（AFNetworkReachabilityStatusUnknown）
- 可能需要在网络权限获取完成后再初始化网络请求管理器

### 3. 内页参数问题
需要在下次运行时查看新增的日志，特别是：
- 原始请求数据
- getActivityDetail的参数传递情况

## 建议解决方案

### 1. 修复Token刷新
在ClientSetting.plist中正确配置：
```
AppId: xiangzhan$ios$g8u9t60p
AppSecret: $yas6WwyP7By9agE
```

### 2. 优化启动流程
考虑在网络权限完全获取后再进行首页加载，避免过早的网络请求失败

### 3. 调试内页参数
根据新增的日志信息，定位参数丢失的具体位置

## 测试步骤
1. 清理应用数据，重新安装
2. 启动应用，查看配置加载日志
3. 观察网络权限获取时间
4. 检查Token刷新是否成功
5. 进入内页，查看参数传递日志