# 网络请求失败根本原因分析

## 修改时间
2025-08-01 22:30

## 问题总结

网络请求失败的根本原因是：
1. H5页面内的JavaScript代码直接使用了浏览器的fetch/XMLHttpRequest API
2. 这些请求不经过Native的ClientJsonRequestManager，而是直接通过WebView的网络层
3. 在iOS网络权限受限期间（CTCellularDataRestricted），所有网络请求都会被系统拒绝

## 详细分析

### 1. 网络请求路径
```
H5页面 (JavaScript) 
    ↓
fetch/XMLHttpRequest API
    ↓
WKWebView网络层
    ↓
iOS系统网络层 ← 这里被网络权限限制拦截
    ↓
错误 -1009: "似乎已断开与互联网的连接"
```

### 2. 为什么ClientJsonRequestManager的日志没有出现
- H5页面没有通过JSBridge调用Native网络请求
- 直接使用了浏览器标准的网络API
- 这些请求不会触发我们添加的任何Native层日志

### 3. 网络权限限制的影响
```
网络状态变化时序：
1. 应用启动 → 网络权限未知/受限（状态1）
2. 等待权限回调（约4秒）
3. 网络权限恢复（状态2）
```

在状态1期间，所有网络请求都会失败：
- 错误码：-1009
- 错误信息：NSURLErrorDomain
- 详细信息：_NSURLErrorNWPathKey=unsatisfied (Denied over Wi-Fi interface)

## 解决方案

### 方案1：延迟H5页面的网络请求（推荐）
在网络权限确认后再允许H5页面发起网络请求：

```objc
// 在WebView加载完成后，通过JavaScript通知页面网络状态
NSString *script = @"window.networkReady = true; "
                   "if (window.onNetworkReady) window.onNetworkReady();";
[self.webView evaluateJavaScript:script completionHandler:nil];
```

### 方案2：拦截并重试失败的请求
监听WebView的网络错误，在权限恢复后自动重试。

### 方案3：优化应用启动流程
1. 提前检查网络权限状态
2. 在权限确认后再加载WebView
3. 添加网络权限引导提示

## 已添加的调试日志

1. **XZWKWebViewBaseController.m**
   - WebView内容检查日志
   - domainOperate执行日志
   - WebView导航请求日志
   - WebView加载失败日志

2. **ClientJsonRequestManager.m** 
   - 网络请求生命周期日志（但H5请求不会触发）

3. **JSNetworkHandler.m**
   - JavaScript桥接请求日志（但H5直接请求不会触发）

## 建议的进一步优化

1. **监控WebView内部请求**
   - 使用WKURLSchemeHandler拦截特定scheme的请求
   - 或者修改H5代码，统一使用JSBridge发起网络请求

2. **优化网络权限处理**
   - 在AppDelegate中优化网络权限检查逻辑
   - 减少权限确认的等待时间

3. **添加网络状态通知机制**
   - 建立Native到H5的网络状态通知通道
   - 让H5能够感知网络权限变化并作出响应