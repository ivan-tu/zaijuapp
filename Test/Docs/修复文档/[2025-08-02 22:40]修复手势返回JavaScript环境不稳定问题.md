# [2025-08-02 22:40]ä¿®å¤æ‰‹åŠ¿è¿”å›JavaScriptç¯å¢ƒä¸ç¨³å®šé—®é¢˜

## ğŸ¯ é—®é¢˜å®šä½

é€šè¿‡æ—¥å¿—åˆ†æï¼Œå‘ç°æ‰‹åŠ¿è¿”å›çš„ä¿®å¤é€»è¾‘åœ¨ `navigationController:didShowViewController:animated:` æ–¹æ³•ä¸­ï¼Œè€Œä¸æ˜¯ä¹‹å‰æŸ¥çœ‹çš„æ‰‹åŠ¿äº¤äº’æ–¹æ³•ã€‚

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹æ–‡ä»¶
`XZNavigationController.m`

### 1. å»¶é•¿ç¨³å®šç­‰å¾…æ—¶é—´ï¼ˆç¬¬908è¡Œï¼‰
```objc
// ä¿®å¤å‰ï¼š
dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(0.3 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{

// ä¿®å¤åï¼š
// ğŸ”§ å…³é”®ä¿®å¤ï¼šå»¶è¿Ÿæ›´é•¿æ—¶é—´ï¼Œè®©JavaScriptç¯å¢ƒå®Œå…¨ç¨³å®š
dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(1.2 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
```

### 2. æ·»åŠ JavaScriptç¯å¢ƒç¨³å®šæ€§æ£€æŸ¥ï¼ˆç¬¬923-969è¡Œï¼‰
åœ¨è§†å›¾å¸ƒå±€ä¹‹åï¼Œé¡µé¢æ¢å¤ç­–ç•¥ä¹‹å‰ï¼Œæ–°å¢JavaScriptç¯å¢ƒæ£€æŸ¥ï¼š

```objc
// ğŸ”§ å…³é”®ä¿®å¤ï¼šæ£€æŸ¥JavaScriptç¯å¢ƒæ˜¯å¦ç¨³å®š
if ([webView isKindOfClass:NSClassFromString(@"WKWebView")]) {
    NSLog(@"åœ¨å±€Claude Code[æ‰‹åŠ¿è¯Šæ–­]+å¼€å§‹JavaScriptç¯å¢ƒç¨³å®šæ€§æ£€æŸ¥");
    
    SEL evalJSSel = NSSelectorFromString(@"evaluateJavaScript:completionHandler:");
    if ([webView respondsToSelector:evalJSSel]) {
        NSString *testJS = @"(function(){ try { return 'js_env_stable'; } catch(e) { return 'js_env_error'; } })()";
        
        // ... æ‰§è¡ŒJavaScriptæµ‹è¯•
        
        void (^stabilityHandler)(id, NSError *) = ^(id result, NSError *error) {
            if (error || !result || ![result isKindOfClass:[NSString class]] || 
                ![(NSString *)result isEqualToString:@"js_env_stable"]) {
                NSLog(@"åœ¨å±€Claude Code[æ‰‹åŠ¿è¯Šæ–­]+âš ï¸ JavaScriptç¯å¢ƒä¸ç¨³å®š: %@", 
                      error ? error.localizedDescription : @"ç»“æœå¼‚å¸¸");
                
                // JavaScriptç¯å¢ƒå¼‚å¸¸ï¼Œå¼ºåˆ¶é‡æ–°åˆå§‹åŒ–æ¡¥æ¥
                [viewController setIsBridgeReady:NO];
                [viewController setupUnifiedJavaScriptBridge];
                NSLog(@"åœ¨å±€Claude Code[æ‰‹åŠ¿è¯Šæ–­]+âœ… å·²é‡æ–°åˆå§‹åŒ–JavaScriptæ¡¥æ¥");
            } else {
                NSLog(@"åœ¨å±€Claude Code[æ‰‹åŠ¿è¯Šæ–­]+âœ… JavaScriptç¯å¢ƒç¨³å®š: %@", result);
            }
        };
    }
}
```

### 3. å»¶è¿Ÿæ‰§è¡Œé¡µé¢æ¢å¤ç­–ç•¥ï¼ˆç¬¬972-994è¡Œï¼‰
å°†é¡µé¢æ¢å¤ç­–ç•¥æ”¾åœ¨JavaScriptç¯å¢ƒæ£€æŸ¥ä¹‹åå»¶è¿Ÿæ‰§è¡Œï¼š

```objc
// 3. å»¶è¿Ÿæ‰§è¡Œé¡µé¢æ¢å¤ç­–ç•¥ï¼Œç¡®ä¿JavaScriptç¯å¢ƒå·²ç»ç¨³å®š
dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(0.3 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
    // é¡µé¢å¯è§æ€§ä¿®å¤
    if ([viewController respondsToSelector:@selector(checkAndFixPageVisibility)]) {
        // ...
    }
    
    // é¡µé¢æ¢å¤ç­–ç•¥
    if ([viewController respondsToSelector:@selector(executePageReloadStrategies)]) {
        // ...
    }
});
```

## ğŸ“Š ä¿®å¤æ•ˆæœ

### æ—¶åºä¼˜åŒ–
1. **æ‰‹åŠ¿è¿”å›å®Œæˆ** â†’ ç«‹å³æ‰§è¡Œ
2. **ç­‰å¾…1.2ç§’** â†’ JavaScriptç¯å¢ƒç¨³å®š
3. **JavaScriptç¯å¢ƒæ£€æŸ¥** â†’ æ£€æµ‹æ˜¯å¦éœ€è¦é‡æ–°åˆå§‹åŒ–
4. **å†ç­‰å¾…0.3ç§’** â†’ ç¡®ä¿æ¡¥æ¥åˆå§‹åŒ–å®Œæˆ
5. **æ‰§è¡Œé¡µé¢æ¢å¤** â†’ æ­¤æ—¶ç¯å¢ƒå·²å®Œå…¨ç¨³å®š

### é¢„æœŸæ—¥å¿—
```
åœ¨å±€Claude Code[æ‰‹åŠ¿è¯Šæ–­]+æ£€æµ‹åˆ°æ‰‹åŠ¿è¿”å›Tabæ ¹é¡µé¢ï¼Œæ‰§è¡Œç‰¹æ®Šä¿®å¤é€»è¾‘
// ç­‰å¾…1.2ç§’...
åœ¨å±€Claude Code[æ‰‹åŠ¿è¯Šæ–­]+1.2ç§’åå¼€å§‹æ‰§è¡Œæ‰‹åŠ¿è¿”å›é¡µé¢ä¿®å¤
åœ¨å±€Claude Code[æ‰‹åŠ¿è¯Šæ–­]+å¼€å§‹JavaScriptç¯å¢ƒç¨³å®šæ€§æ£€æŸ¥
åœ¨å±€Claude Code[æ‰‹åŠ¿è¯Šæ–­]+âœ… JavaScriptç¯å¢ƒç¨³å®š: js_env_stable
// æˆ–è€…å¦‚æœä¸ç¨³å®šï¼š
åœ¨å±€Claude Code[æ‰‹åŠ¿è¯Šæ–­]+âš ï¸ JavaScriptç¯å¢ƒä¸ç¨³å®š: å‘ç”Ÿäº†JavaScriptå¼‚å¸¸
åœ¨å±€Claude Code[æ‰‹åŠ¿è¯Šæ–­]+âœ… å·²é‡æ–°åˆå§‹åŒ–JavaScriptæ¡¥æ¥
```

## ğŸš€ æ ¸å¿ƒæ”¹è¿›

1. **æ™ºèƒ½æ£€æµ‹**ï¼šä¸»åŠ¨æ£€æµ‹JavaScriptæ‰§è¡Œç¯å¢ƒçŠ¶æ€
2. **è‡ªåŠ¨ä¿®å¤**ï¼šç¯å¢ƒä¸ç¨³å®šæ—¶è‡ªåŠ¨é‡æ–°åˆå§‹åŒ–æ¡¥æ¥
3. **æ—¶åºä¼˜åŒ–**ï¼šåˆç†çš„å»¶è¿Ÿç¡®ä¿ç¯å¢ƒå®Œå…¨ç¨³å®š
4. **åˆ†æ­¥æ‰§è¡Œ**ï¼šç¯å¢ƒæ£€æŸ¥å’Œé¡µé¢æ¢å¤åˆ†æ­¥è¿›è¡Œ

## âš ï¸ é‡è¦æç¤º

è¯·é‡æ–°ç¼–è¯‘é¡¹ç›®ä»¥ä½¿ä¿®å¤ç”Ÿæ•ˆã€‚ä¿®å¤åæ‰‹åŠ¿è¿”å›Tabé¡µåº”è¯¥èƒ½å¤Ÿæ­£å¸¸æ˜¾ç¤ºå†…å®¹ï¼Œæ— éœ€æ‰‹åŠ¨åˆ‡æ¢Tabã€‚

## ğŸ”¬ éªŒè¯æ–¹æ³•

1. è¿›å…¥å†…é¡µ
2. æ‰‹åŠ¿è¿”å›åˆ°Tabé¡µ
3. è§‚å¯Ÿæ—¥å¿—ä¸­æ˜¯å¦æœ‰"1.2ç§’åå¼€å§‹æ‰§è¡Œ"çš„æ—¥å¿—
4. æ£€æŸ¥JavaScriptç¯å¢ƒç¨³å®šæ€§æ£€æŸ¥ç»“æœ
5. ç¡®è®¤é¡µé¢æ˜¯å¦æ­£å¸¸æ˜¾ç¤º