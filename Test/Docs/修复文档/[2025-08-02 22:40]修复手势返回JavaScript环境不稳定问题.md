# [2025-08-02 22:40]修复手势返回JavaScript环境不稳定问题

## 🎯 问题定位

通过日志分析，发现手势返回的修复逻辑在 `navigationController:didShowViewController:animated:` 方法中，而不是之前查看的手势交互方法。

## ✅ 修复方案

### 修改文件
`XZNavigationController.m`

### 1. 延长稳定等待时间（第908行）
```objc
// 修复前：
dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(0.3 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{

// 修复后：
// 🔧 关键修复：延迟更长时间，让JavaScript环境完全稳定
dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(1.2 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
```

### 2. 添加JavaScript环境稳定性检查（第923-969行）
在视图布局之后，页面恢复策略之前，新增JavaScript环境检查：

```objc
// 🔧 关键修复：检查JavaScript环境是否稳定
if ([webView isKindOfClass:NSClassFromString(@"WKWebView")]) {
    NSLog(@"在局Claude Code[手势诊断]+开始JavaScript环境稳定性检查");
    
    SEL evalJSSel = NSSelectorFromString(@"evaluateJavaScript:completionHandler:");
    if ([webView respondsToSelector:evalJSSel]) {
        NSString *testJS = @"(function(){ try { return 'js_env_stable'; } catch(e) { return 'js_env_error'; } })()";
        
        // ... 执行JavaScript测试
        
        void (^stabilityHandler)(id, NSError *) = ^(id result, NSError *error) {
            if (error || !result || ![result isKindOfClass:[NSString class]] || 
                ![(NSString *)result isEqualToString:@"js_env_stable"]) {
                NSLog(@"在局Claude Code[手势诊断]+⚠️ JavaScript环境不稳定: %@", 
                      error ? error.localizedDescription : @"结果异常");
                
                // JavaScript环境异常，强制重新初始化桥接
                [viewController setIsBridgeReady:NO];
                [viewController setupUnifiedJavaScriptBridge];
                NSLog(@"在局Claude Code[手势诊断]+✅ 已重新初始化JavaScript桥接");
            } else {
                NSLog(@"在局Claude Code[手势诊断]+✅ JavaScript环境稳定: %@", result);
            }
        };
    }
}
```

### 3. 延迟执行页面恢复策略（第972-994行）
将页面恢复策略放在JavaScript环境检查之后延迟执行：

```objc
// 3. 延迟执行页面恢复策略，确保JavaScript环境已经稳定
dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(0.3 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
    // 页面可见性修复
    if ([viewController respondsToSelector:@selector(checkAndFixPageVisibility)]) {
        // ...
    }
    
    // 页面恢复策略
    if ([viewController respondsToSelector:@selector(executePageReloadStrategies)]) {
        // ...
    }
});
```

## 📊 修复效果

### 时序优化
1. **手势返回完成** → 立即执行
2. **等待1.2秒** → JavaScript环境稳定
3. **JavaScript环境检查** → 检测是否需要重新初始化
4. **再等待0.3秒** → 确保桥接初始化完成
5. **执行页面恢复** → 此时环境已完全稳定

### 预期日志
```
在局Claude Code[手势诊断]+检测到手势返回Tab根页面，执行特殊修复逻辑
// 等待1.2秒...
在局Claude Code[手势诊断]+1.2秒后开始执行手势返回页面修复
在局Claude Code[手势诊断]+开始JavaScript环境稳定性检查
在局Claude Code[手势诊断]+✅ JavaScript环境稳定: js_env_stable
// 或者如果不稳定：
在局Claude Code[手势诊断]+⚠️ JavaScript环境不稳定: 发生了JavaScript异常
在局Claude Code[手势诊断]+✅ 已重新初始化JavaScript桥接
```

## 🚀 核心改进

1. **智能检测**：主动检测JavaScript执行环境状态
2. **自动修复**：环境不稳定时自动重新初始化桥接
3. **时序优化**：合理的延迟确保环境完全稳定
4. **分步执行**：环境检查和页面恢复分步进行

## ⚠️ 重要提示

请重新编译项目以使修复生效。修复后手势返回Tab页应该能够正常显示内容，无需手动切换Tab。

## 🔬 验证方法

1. 进入内页
2. 手势返回到Tab页
3. 观察日志中是否有"1.2秒后开始执行"的日志
4. 检查JavaScript环境稳定性检查结果
5. 确认页面是否正常显示