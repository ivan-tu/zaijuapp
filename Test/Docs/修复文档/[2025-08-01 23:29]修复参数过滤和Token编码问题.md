# 修复参数过滤和Token编码问题

## 修改时间
2025-08-01 23:29

## 问题分析

1. **内页没有数据显示**
   - API返回"缺少必要参数"
   - 原因：JSNetworkHandler过滤掉了空字符串参数
   - `/admin/getArticleInfo`需要`id:""`参数，但被过滤掉了

2. **Token刷新失败**
   - 返回"empty appid or appsecret"
   - 原因：特殊字符`$`可能没有正确编码

## 修复方案

### 1. 修改参数过滤逻辑
在`JSNetworkHandler.m`中，保留空字符串参数：
```objc
// 过滤掉null参数，但保留空字符串参数（某些API需要空字符串参数）
NSMutableDictionary *parameters = [NSMutableDictionary dictionary];
for (NSString *key in originalParameters) {
    id value = originalParameters[key];
    if (value && ![value isEqual:[NSNull null]]) {
        parameters[key] = value;
    }
}
```

### 2. 优化Token请求的URL编码
在`ClientJsonRequestManager.m`中，使用更严格的编码：
```objc
// 构建POST body - 使用更严格的URL编码
NSMutableCharacterSet *allowedCharacterSet = [NSMutableCharacterSet alphanumericCharacterSet];
[allowedCharacterSet addCharactersInString:@"-._~"]; // URL安全字符

NSString *encodedAppId = [appId stringByAddingPercentEncodingWithAllowedCharacters:allowedCharacterSet];
NSString *encodedAppSecret = [appSecret stringByAddingPercentEncodingWithAllowedCharacters:allowedCharacterSet];
```

## 测试要点

1. 重新编译运行
2. 检查内页是否正确显示数据
3. 查看日志中Token编码是否正确（`$`应该被编码为`%24`）
4. 验证Token刷新是否成功

## 注意事项

- 有些API区分"参数不存在"和"参数为空字符串"
- 特殊字符在URL参数中需要正确编码
- 保持与服务器API的兼容性