# 修复Token刷新和内页参数问题

## 修改时间
2025-08-01 22:45

## 修复的问题

### 1. Token刷新失败
**问题现象**：
```
在局Claude Code[Token刷新]+解析结果: {
    code = 1;
    errorMessage = "empty appid or appsecret";
}
```

**原因分析**：
- AppId包含特殊字符：`xiangzhan$ios$g8u9t60p`
- AppSecret以特殊字符开头：`$yas6WwyP7By9agE`
- 这些特殊字符（$）在URL中需要编码，否则服务器无法正确解析

**修复方案**：
在Token刷新请求前对参数进行URL编码

### 2. 内页参数丢失
**问题现象**：
- 第一次请求getActivityDetail有参数：`{id = "687849a94650fa6c2b544141"}`
- 第二次请求参数为空：`{}`

**原因分析**：
- 可能是页面切换时JavaScript状态丢失
- 或者是pageShow事件触发时没有正确恢复参数

## 修改文件

### ClientJsonRequestManager.m
```objc
// 修改前
NSString *urlString = [NSString stringWithFormat:@"%@/oauth/getAccessToken?appId=%@&appSecret=%@",
    [ClientSettingModel sharedInstance].domain,
    [ClientSettingModel sharedInstance].appId,
    [ClientSettingModel sharedInstance].appSecret];

// 修改后
NSString *appId = [ClientSettingModel sharedInstance].appId;
NSString *appSecret = [ClientSettingModel sharedInstance].appSecret;
NSString *encodedAppId = [appId stringByAddingPercentEncodingWithAllowedCharacters:[NSCharacterSet URLQueryAllowedCharacterSet]];
NSString *encodedAppSecret = [appSecret stringByAddingPercentEncodingWithAllowedCharacters:[NSCharacterSet URLQueryAllowedCharacterSet]];
NSString *urlString = [NSString stringWithFormat:@"%@/oauth/getAccessToken?appId=%@&appSecret=%@",
    [ClientSettingModel sharedInstance].domain, encodedAppId, encodedAppSecret];
```

## 测试要点

1. Token刷新应该成功，不再返回"empty appid or appsecret"错误
2. 所有API请求应该带上正确的Authorization header
3. 内页切换时参数应该保持不变

## 剩余问题

内页参数丢失问题可能需要：
1. 检查JavaScript代码如何处理页面切换
2. 确保pageShow事件正确恢复页面状态
3. 可能需要在Native层缓存页面参数