# 修复网络请求处理问题

## 修改时间
2025-08-01 21:30

## 问题描述
1. POST请求使用错误的Content-Type（application/x-www-form-urlencoded），导致服务器接收不到JSON参数
2. 存在重复请求问题：无headers参数的POST方法内部又调用了父类的POST方法，可能导致请求被执行两次

## 问题分析
1. **Content-Type问题**：
   - 原项目JavaScript使用 `'content-type': 'application/json'`
   - 但Native代码使用AFNetworking默认的 `application/x-www-form-urlencoded`
   - 服务器期望接收JSON格式的请求体

2. **重复请求问题**：
   - 存在两个POST方法：一个带headers参数，一个不带
   - 无headers参数的POST方法内部处理了缓存、token检查等逻辑后，又调用了父类的POST方法
   - 这可能导致某些情况下请求被执行两次

## 修复方案

### 1. 修复POST请求的Content-Type
在带headers参数的POST方法中，设置请求序列化器为JSON格式：
```objc
// 在局Claude Code修复：设置请求序列化器为JSON格式
AFJSONRequestSerializer *jsonSerializer = [AFJSONRequestSerializer serializer];
self.requestSerializer = jsonSerializer;

// 设置请求头
if (headers) {
    for (NSString *key in headers) {
        [self.requestSerializer setValue:headers[key] forHTTPHeaderField:key];
    }
}
```

并在请求完成后恢复默认的请求序列化器：
```objc
// 在局Claude Code修复：恢复默认的请求序列化器
self.requestSerializer = [AFHTTPRequestSerializer serializer];
```

### 2. 修复重复请求问题
将无headers参数的POST方法简化为直接调用带headers参数的版本：
```objc
- (void)POST:(NSString *)URLString parameters:(id)parameters block:(ClientCompletionBlock)block
{
    // 在局Claude Code修复：直接调用带headers参数的POST方法，避免重复处理
    [self POST:URLString parameters:parameters headers:nil block:block];
}
```

## 修改的文件
- `XZVientiane/ClientBase/BaseNet/ClientJsonRequestManager.m`

## 测试要点
1. 重新编译运行
2. 进入活动详情页，检查数据是否正常显示
3. 检查网络请求日志，确认：
   - POST请求使用了正确的Content-Type
   - 每个接口只请求一次，没有重复请求
4. 检查各个内页的数据显示是否正常

## 预期结果
- POST请求使用application/json格式发送参数
- 服务器能正确接收并解析参数
- 不再出现"缺少必要参数"的错误
- 每个接口只请求一次，提高性能
