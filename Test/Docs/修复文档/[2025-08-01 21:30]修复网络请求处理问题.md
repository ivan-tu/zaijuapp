# [2025-08-01 21:30]修复网络请求处理问题

## 问题描述
加载内页时没有正常请求数据，服务器返回"缺少必要参数"错误，同时出现同步网络请求警告。

## 问题分析

### 1. 无限递归调用问题
- **位置**: `ClientJsonRequestManager.m:92` 和 `ClientJsonRequestManager.m:121`
- **问题**: 在GET/POST方法中调用`[self GET:...]`导致无限递归
- **影响**: 会导致程序崩溃或请求失败

### 2. 同步网络请求问题  
- **位置**: `ClientJsonRequestManager.m:224`
- **问题**: 使用`stringWithContentsOfURL`进行同步网络请求
- **影响**: 阻塞主线程，导致UI无响应

### 3. Headers传递问题
- **问题**: JS传递的重要headers（clientKey, xzAppId, session等）可能因为递归调用问题无法正确传递到服务器
- **影响**: 服务器无法识别请求来源，返回"缺少必要参数"

## 修复方案

### 1. 修复无限递归调用
```objc
// 修复前
[self GET:URLString parameters:parameters headers:headers progress:nil success:...]

// 修复后  
[super GET:URLString parameters:parameters headers:headers progress:nil success:...]
```

### 2. 修复同步网络请求
```objc
// 修复前：同步请求
NSString *resultString = [NSString stringWithContentsOfURL:[NSURL URLWithString:urlString] encoding:NSUTF8StringEncoding error:nil];

// 修复后：异步请求
NSURLRequest *request = [NSURLRequest requestWithURL:[NSURL URLWithString:urlString]];
NSURLSessionDataTask *task = [[NSURLSession sharedSession] dataTaskWithRequest:request completionHandler:^(NSData *data, NSURLResponse *response, NSError *error) {
    // 异步处理响应
}];
[task resume];
```

## 修改文件
- `XZVientiane/ClientBase/BaseNet/ClientJsonRequestManager.m`
  - 修复GET方法递归调用 (第92行)
  - 修复POST方法递归调用 (第121行)  
  - 修复checkAppToken同步请求 (第224行)

## 预期效果
1. 网络请求能正常传递headers到服务器
2. 消除同步网络请求警告
3. 避免无限递归导致的程序崩溃
4. 内页数据能正常加载

## 风险评估
- **低风险**: 修复的都是明显的代码bug
- **注意**: token刷新现在是异步的，可能在某些极端情况下第一次请求使用旧token

## 测试建议
1. 测试内页加载是否正常
2. 检查Xcode控制台不再出现同步网络请求警告
3. 验证headers是否正确传递到服务器
4. 测试token过期后的自动刷新机制