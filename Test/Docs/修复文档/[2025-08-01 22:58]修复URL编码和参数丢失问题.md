# 修复URL编码和参数丢失问题

## 修改时间
2025-08-01 22:58

## 问题分析

### 1. Token刷新URL编码问题
虽然代码中已经添加了URL编码，但日志显示URL中的特殊字符`$`没有被编码：
```
在局Claude Code[Token刷新]+请求URL: https://zaiju.com/oauth/getAccessToken?appId=xiangzhan$ios$g8u9t60p&appSecret=$yas6WwyP7By9agE
```

问题原因：`URLQueryAllowedCharacterSet`默认允许`$`字符，不会对其编码。

### 2. 内页参数丢失
页面切换时（pageHide -> pageShow），第二次请求的参数为空。

## 修复方案

### 1. 修复URL编码问题

在 ClientJsonRequestManager.m 的 checkAppToken 方法中，使用自定义字符集：

```objc
// 创建自定义字符集，只允许字母和数字
NSMutableCharacterSet *allowedCharacterSet = [NSMutableCharacterSet alphanumericCharacterSet];
NSString *encodedAppId = [appId stringByAddingPercentEncodingWithAllowedCharacters:allowedCharacterSet];
NSString *encodedAppSecret = [appSecret stringByAddingPercentEncodingWithAllowedCharacters:allowedCharacterSet];
```

或者手动替换特殊字符：
```objc
NSString *encodedAppId = [appId stringByReplacingOccurrencesOfString:@"$" withString:@"%24"];
NSString *encodedAppSecret = [appSecret stringByReplacingOccurrencesOfString:@"$" withString:@"%24"];
```

### 2. 修复内页参数丢失问题

这是JavaScript端的问题，可能的解决方案：

1. **在Native层缓存页面参数**
   - 在navigateTo时保存参数
   - 在pageShow时恢复参数

2. **通知JavaScript保存状态**
   ```javascript
   // 在pageHide时保存状态
   window.xzBridge.registerHandler('pageHide', function() {
       // 保存当前页面参数
       sessionStorage.setItem('activityId', currentActivityId);
   });
   
   // 在pageShow时恢复状态
   window.xzBridge.registerHandler('pageShow', function() {
       // 恢复页面参数
       const activityId = sessionStorage.getItem('activityId');
       if (activityId) {
           loadActivityDetail(activityId);
       }
   });
   ```

## 测试要点

1. Token刷新应该成功
2. 内页切换时参数应该保持
3. 所有API请求应该正常返回数据

## 建议

由于内页参数丢失是JavaScript端的问题，建议：
1. 检查H5代码中的页面状态管理
2. 确保pageShow事件正确恢复页面数据
3. 考虑使用sessionStorage或其他持久化方案