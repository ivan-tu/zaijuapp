# TabBar和首页加载逻辑分析

## 查找结果总结

### 1. TabBar相关的控制器文件

- **主要TabBar控制器**: `/Users/ivan/工作/Tuweia/app/在局/zaijuapp/XZVientiane/XZBase/BaseController/XZTabBarController.m`
- **自定义TabBar视图**: `/Users/ivan/工作/Tuweia/app/在局/zaijuapp/XZVientiane/XZBase/BaseView/CustomTabBar.h/m`

### 2. Tab页的创建和加载逻辑

#### 2.1 Tab配置文件
- **配置文件路径**: `/Users/ivan/工作/Tuweia/app/在局/zaijuapp/XZVientiane/appInfo.json`
- **Tab配置内容**:
  ```json
  "items" : [
      {
          "active" : "1",
          "icon" : "icon_home",
          "name" : "在局",
          "activeIcon" : "icon_homeSelect",
          "url" : "https://zaiju.com/p/home/index/index",
          "isCheck":"1"  // 第一个tab，需要检查版本更新
      },
      {
          "active" : "0",
          "icon" : "icon_xiaoxi",
          "name" : "俱乐部",
          "activeIcon" : "icon_xiaoxiSelect",
          "url" : "https://zaiju.com/p/suboffice/index/index",
          "isCheck":"0"
      },
      {
          "active" : "0",
          "icon" : "icon_userCenter",
          "name" : "我的",
          "activeIcon" : "icon_userCenterSelect",
          "url" : "https://zaiju.com/p/user/my/my",
          "isCheck":"0"
      }
  ]
  ```

#### 2.2 Tab创建流程（XZTabBarController.m）
```objc
// 在reloadTabbarInterface方法中
for (NSInteger index = 0; index < tabs.count; index++) {
    NSDictionary *dic = tabs[index];
    
    // 只为第一个tab创建ViewController，其他的延迟创建
    UIViewController *rootVC = nil;
    if (index == 0) {
        CFJClientH5Controller *homeVC = [[CFJClientH5Controller alloc] init];
        if ([[dic objectForKey:@"isCheck"] isEqualToString:@"1"]) {
            homeVC.isCheck = YES;
        }
        homeVC.isTabbarShow = YES;
        homeVC.pinUrl = [dic objectForKey:@"url"];
        rootVC = homeVC;
    } else {
        // 创建一个轻量级的占位ViewController
        UIViewController *placeholderVC = [[UIViewController alloc] init];
        placeholderVC.view.backgroundColor = [UIColor whiteColor];
        // 将配置信息存储在占位ViewController中
        objc_setAssociatedObject(placeholderVC, @"tabConfig", dic, OBJC_ASSOCIATION_RETAIN_NONATOMIC);
        objc_setAssociatedObject(placeholderVC, @"tabIndex", @(index), OBJC_ASSOCIATION_RETAIN_NONATOMIC);
        rootVC = placeholderVC;
    }
}
```

### 3. 第一个Tab页（首页）的初始化和加载方式

#### 3.1 首页URL
- **URL**: `https://zaiju.com/p/home/index/index`
- **特点**: 第一个tab设置了`isCheck: 1`，会在加载后检查版本更新

#### 3.2 首页加载时机
1. **应用启动时**（AppDelegate.m）:
   ```objc
   - (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions {
       // 立即创建TabBar控制器
       self.tabbarVC = [[XZTabBarController alloc] init];
       self.window.rootViewController = self.tabbarVC;
       [self.tabbarVC reloadTabbarInterface];
   }
   ```

2. **TabBar初始化后**:
   - 第一个tab会立即创建`CFJClientH5Controller`实例
   - 其他tab使用占位ViewController，点击时才创建真实的控制器

3. **首页特殊处理**（XZTabBarController.m）:
   ```objc
   // 确保第一个tab正确加载
   if (tabbarItems.count > 0) {
       [self ensureFirstTabLoaded:tabbarItems];
   }
   ```

### 4. WebView的创建时机和加载URL的逻辑

#### 4.1 WebView创建时机
- **延迟创建策略**: WebView在`viewDidAppear`中创建，避免影响启动性能
- **创建流程**:
  1. `viewDidLoad` -> 设置导航栏等基础配置
  2. `viewDidAppear` -> 调用`setupAndLoadWebViewIfNeeded`创建WebView
  3. `domainOperate` -> 处理URL加载逻辑

#### 4.2 URL加载逻辑（XZWKWebViewBaseController.m）
```objc
- (void)domainOperate {
    // 检查是否为外部网络URL
    if (self.pinUrl && self.pinUrl.length > 0) {
        BOOL isNetworkURL = [self.pinUrl hasPrefix:@"http://"] || [self.pinUrl hasPrefix:@"https://"];
        
        if (isNetworkURL) {
            // 判断是否为外部URL（非应用域名）
            NSString *appDomain = [[NSUserDefaults standardUserDefaults] objectForKey:@"kUserDefaults_domainStr"];
            BOOL isExternalURL = !containsAppDomain;
            
            if (isExternalURL) {
                // 直接加载网络URL
                NSURL *url = [NSURL URLWithString:self.pinUrl];
                NSURLRequest *request = [NSURLRequest requestWithURL:url];
                [self.webView loadRequest:request];
            } else {
                // 加载本地HTML模板
                [CustomHybridProcessor custom_LocialPathByUrlStr:self.pinUrl ...];
            }
        }
    }
}
```

### 5. 关键优化点

1. **懒加载策略**: 除首页外的其他tab使用占位ViewController，点击时才创建真实控制器
2. **WebView延迟创建**: 在`viewDidAppear`中创建，避免阻塞启动
3. **防重复加载**: 通过`hasValidWebViewContent`检查避免重复加载
4. **加载监控**: 通过`startPageLoadMonitor`监控页面加载状态

### 6. 首页加载完成的通知机制

```objc
// 首页加载完成后移除LoadingView
[[NSNotificationCenter defaultCenter] addObserverForName:@"showTabviewController" 
    object:nil 
    queue:[NSOperationQueue mainQueue] 
    usingBlock:^(NSNotification *note) {
        // 移除LoadingView
        [appDelegate removeGlobalLoadingViewWithReason:@"首页pageReady完成"];
}];
```

## 总结

1. TabBar在应用启动时立即创建，不等待网络权限检查
2. 第一个tab（首页）会立即创建控制器实例，其他tab延迟创建
3. WebView在`viewDidAppear`中创建，避免影响启动性能
4. 首页URL通过`appInfo.json`配置，支持本地HTML和网络URL两种加载方式
5. 整个加载流程有完善的监控和防重复机制