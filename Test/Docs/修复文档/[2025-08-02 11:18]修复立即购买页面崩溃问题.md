# 修复立即购买页面崩溃问题

## 问题描述
用户反馈点击"立即购买"按钮后页面会崩溃，可能与接口请求数据格式有关。

## 问题分析

### 1. 数据流程
1. 用户在商品详情页点击"立即购买"
2. JavaScript将商品数据存储为数组格式：`[{goodsid, format, quantity, weight, shopid}]`
3. 跳转到结算页面，调用 `getCheckOut` 接口传递数组参数
4. Native端处理网络请求

### 2. 问题定位
通过代码分析和崩溃日志发现问题出在三个地方：
- `xz-app.js` 中的 `request` 方法会将未定义的 `data` 默认设置为空对象 `{}`，导致数组参数丢失
- `JSNetworkHandler.m` 只处理字典类型的参数，不支持数组类型
- `ClientJsonRequestManager.m` 中的缓存键生成方法 `urlWithParam:andHead:` 调用了数组不支持的 `allKeys` 方法

### 3. 根本原因
结算接口 `getCheckOut` 需要接收数组格式的商品数据，但系统在三个层面都不支持：
1. JavaScript层会错误地将数组转换为空对象
2. Native网络处理层只支持字典格式
3. 缓存系统无法为数组参数生成正确的缓存键

崩溃具体发生在：`-[__NSSingleObjectArrayI allKeys]: unrecognized selector sent to instance`

## 修复方案

### 1. 修复 JSNetworkHandler.m
文件：`/XZVientiane/ClientBase/JSBridge/Handlers/JSNetworkHandler.m`

```objc
// 支持数组和字典类型的参数
id parameters = nil;

if ([originalParameters isKindOfClass:[NSArray class]]) {
    // 如果是数组，直接使用，不进行null过滤
    NSLog(@"在局Claude Code[数组参数]+请求参数是数组类型: %@", originalParameters);
    parameters = originalParameters;
} else if ([originalParameters isKindOfClass:[NSDictionary class]]) {
    // 如果是字典，过滤掉null参数，但保留空字符串参数
    NSMutableDictionary *filteredParams = [NSMutableDictionary dictionary];
    NSDictionary *dictParams = (NSDictionary *)originalParameters;
    for (NSString *key in dictParams) {
        id value = dictParams[key];
        if (value && ![value isEqual:[NSNull null]]) {
            filteredParams[key] = value;
        }
    }
    parameters = filteredParams;
} else {
    // 其他类型，保持原样
    parameters = originalParameters;
}
```

### 2. 修复 xz-app.js
文件：`/XZVientiane/manifest/static/app/xz-app.js`

关键修改：移除else分支，保留原始data类型
```javascript
request(obj) {
    if(obj.data && typeof obj.data == 'string'){
        obj.data = JSON.parse(obj.data);
    }
    // 移除else分支，不要将undefined/null默认设置为{}
    // 这样可以保留数组类型的参数
    
    wx.app.call('request', {
        success: obj.success,
        fail: obj.fail,
        complete: obj.complete,
        data: {
            header: obj.header,
            data: obj.data,
            url:obj.url
        }
    });
}
```

### 3. 修复 ClientJsonRequestManager.m
文件：`/XZVientiane/ClientBase/BaseNet/ClientJsonRequestManager.m`

新增安全的缓存键生成方法：
```objc
- (NSString *)safeCacheKeyWithParameters:(id)parameters andURL:(NSString *)URLString {
    if ([parameters isKindOfClass:[NSDictionary class]]) {
        return [NSString urlWithParam:parameters andHead:URLString];
    } else {
        // 对于数组参数，使用JSON字符串作为缓存键
        NSString *parametersString = @"";
        if (parameters) {
            NSError *error = nil;
            NSData *jsonData = [NSJSONSerialization dataWithJSONObject:parameters options:0 error:&error];
            if (!error && jsonData) {
                parametersString = [[NSString alloc] initWithData:jsonData encoding:NSUTF8StringEncoding];
                // 清理特殊字符
                parametersString = [parametersString stringByReplacingOccurrencesOfString:@"/" withString:@"_"];
                // ... 其他字符替换
            }
        }
        NSString *cacheKey = [NSString stringWithFormat:@"%@_%@", URLString, parametersString];
        return [cacheKey stringByReplacingOccurrencesOfString:@"/" withString:@"_"];
    }
}
```

### 4. 添加Native端日志跟踪
在以下位置添加了NSLog日志（Xcode可见）：
- `JSNetworkHandler.m` - 记录数组参数类型
- `ClientJsonRequestManager.m` - POST请求的参数类型和内容

## 测试建议

1. 点击"立即购买"按钮，确认不再崩溃
2. 在Xcode控制台查看日志：
   - 搜索"在局Claude Code"可以看到所有相关日志
   - 确认看到"请求参数是数组类型"的日志
   - 查看POST请求的参数内容
3. 确认结算页面能正常加载商品信息
4. 测试其他使用字典参数的接口仍然正常工作

## 注意事项

1. 只需要修改两个文件即可解决问题
2. JavaScript的console.log在Xcode中看不到，所以使用Native端的NSLog
3. 修改后需要重新编译项目
4. 建议测试多种商品类型的购买流程

## 相关文件（共修改了三个）
- `/XZVientiane/ClientBase/JSBridge/Handlers/JSNetworkHandler.m` - 支持数组参数
- `/XZVientiane/manifest/static/app/xz-app.js` - 保留原始数据类型
- `/XZVientiane/ClientBase/BaseNet/ClientJsonRequestManager.m` - 修复缓存键生成